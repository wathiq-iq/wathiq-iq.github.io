<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise GIS Geometry Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        pre { font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        #map { width: 100%; height: 100%; border-radius: 0.5rem; z-index: 1; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div class="max-w-6xl mx-auto p-6 space-y-6">
        <!-- Header -->
        <header class="flex justify-between items-center bg-slate-900 text-white p-6 rounded-2xl shadow-xl">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">GIS Geometry Engine</h1>
                <p class="text-slate-400 text-sm">Batch Processing & Visualizer</p>
            </div>
            <div id="statusIndicator" class="px-4 py-2 rounded-full text-xs font-mono bg-green-500/20 text-green-400 border border-green-500/30">
                ENGINE READY
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Input Section -->
            <section class="lg:col-span-1 space-y-4">
                <div class="glass-panel p-5 rounded-2xl shadow-sm space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="font-bold flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Input Data
                        </h2>
                        <input type="file" id="fileUpload" class="hidden" accept=".json,.txt">
                        <button onclick="document.getElementById('fileUpload').click()" class="text-[10px] px-2 py-1 bg-blue-50 text-blue-600 rounded border border-blue-100 hover:bg-blue-100 transition-colors">
                            Upload JSON
                        </button>
                    </div>
                    
                    <p class="text-xs text-slate-500">Input JSON with <code>items: [{ siteId, multiCoordinates }]</code>.</p>
                    
                    <textarea id="jsonInput" class="w-full h-64 p-3 rounded-lg border border-slate-200 text-xs font-mono focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder='{ "items": [ { "siteId": "LOC-1", "multiCoordinates": [...] } ] }'></textarea>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="loadSample(3)" class="text-xs py-2 bg-slate-100 hover:bg-slate-200 rounded font-medium transition-colors">Sample (3)</button>
                        <button onclick="loadSample(25)" class="text-xs py-2 bg-slate-100 hover:bg-slate-200 rounded font-medium transition-colors">Sample (25)</button>
                    </div>

                    <button id="processBtn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all shadow-lg shadow-blue-200">
                        Process Batch Geometry
                    </button>
                </div>
            </section>

            <!-- Results Section -->
            <section class="lg:col-span-2 space-y-4 flex flex-col min-h-[500px]">
                <div class="glass-panel p-5 rounded-2xl shadow-sm flex-grow flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-bold">Output & Visualization</h2>
                        <div id="performanceMetrics" class="text-[10px] font-mono text-slate-400"></div>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="showFormat('geojson')" class="view-tab px-4 py-1.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700" data-format="geojson">GeoJSON</button>
                        <button onclick="showFormat('map')" class="view-tab px-4 py-1.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 hover:bg-slate-200" data-format="map">Map Preview</button>
                        <button onclick="showFormat('wkt')" class="view-tab px-4 py-1.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 hover:bg-slate-200" data-format="wkt">WKT</button>
                        <button onclick="showFormat('kml')" class="view-tab px-4 py-1.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 hover:bg-slate-200" data-format="kml">KML</button>
                    </div>

                    <div class="flex-grow relative overflow-hidden rounded-lg border border-slate-200 bg-white">
                        <div id="codeContainer" class="absolute inset-0 p-4 overflow-auto">
                            <pre id="outputCode" class="whitespace-pre-wrap break-all text-slate-700"></pre>
                        </div>
                        <div id="mapContainer" class="absolute inset-0 hidden">
                            <div id="map"></div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-end gap-2">
                        <button onclick="copyToClipboard()" class="flex items-center gap-2 px-4 py-2 text-xs font-medium border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            Copy
                        </button>
                        <button id="downloadBtn" onclick="downloadOutput()" class="flex items-center gap-2 px-4 py-2 text-xs font-bold bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors disabled:opacity-50" disabled>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Download
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal for Errors -->
    <div id="errorModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
            <h3 class="text-red-600 font-bold text-lg mb-2">Processing Error</h3>
            <p id="errorMessage" class="text-slate-600 text-sm mb-6"></p>
            <button onclick="closeError()" class="w-full py-2 bg-slate-900 text-white rounded-lg font-medium">Close</button>
        </div>
    </div>

    <script type="module">
        const workerCode = `
            class CanonicalGeometry {
                constructor(type, siteId) {
                    this.type = type;
                    this.siteId = siteId;
                    this.rings = []; 
                }
            }

            self.onmessage = async function(e) {
                const { input, format } = e.data;
                const start = performance.now();

                try {
                    const root = typeof input === 'string' ? JSON.parse(input) : input;
                    const items = Array.isArray(root.items) ? root.items : [root];
                    const geometries = [];

                    for (const item of items) {
                        const siteId = String(item.siteId || "unknown");
                        const rawCoords = item.multiCoordinates;
                        if (!Array.isArray(rawCoords) || rawCoords.length === 0) continue;

                        const geom = new CanonicalGeometry('Polygon', siteId);
                        const getCoord = (p, idx) => {
                            if (Array.isArray(p)) return p[idx];
                            if (idx === 0) return p.longitude || p.lon || p.lng;
                            return p.latitude || p.lat;
                        };

                        const firstLon = getCoord(rawCoords[0], 0);
                        const firstLat = getCoord(rawCoords[0], 1);
                        let ringSize = rawCoords.length;
                        const lastPt = rawCoords[rawCoords.length - 1];
                        const isClosed = (getCoord(lastPt, 0) === firstLon && getCoord(lastPt, 1) === firstLat);
                        if (!isClosed) ringSize += 1;

                        const f64 = new Float64Array(ringSize * 2);
                        for (let i = 0; i < rawCoords.length; i++) {
                            f64[i * 2] = getCoord(rawCoords[i], 0);
                            f64[i * 2 + 1] = getCoord(rawCoords[i], 1);
                        }
                        if (!isClosed) {
                            f64[(ringSize - 1) * 2] = firstLon;
                            f64[(ringSize - 1) * 2 + 1] = firstLat;
                        }
                        geom.rings.push(f64);
                        geometries.push(geom);
                    }

                    if (geometries.length === 0) throw new Error("No valid items found.");

                    let result = "";
                    if (format === 'geojson') result = toGeoJSONBatch(geometries);
                    else if (format === 'wkt') result = toWKTBatch(geometries);
                    else if (format === 'kml') result = toKMLBatch(geometries);

                    const end = performance.now();
                    self.postMessage({ 
                        success: true, 
                        data: result, 
                        count: geometries.length,
                        firstSiteId: geometries[0].siteId,
                        ms: (end - start).toFixed(2)
                    });
                } catch (err) {
                    self.postMessage({ success: false, error: err.message });
                }
            };

            function toGeoJSONBatch(geoms) {
                const features = geoms.map(g => ({
                    type: "Feature",
                    properties: { Zone: g.siteId },
                    geometry: { 
                        type: "Polygon", 
                        coordinates: g.rings.map(r => {
                            const arr = [];
                            for(let i=0; i<r.length; i+=2) arr.push([r[i], r[i+1]]);
                            return arr;
                        })
                    }
                }));
                return JSON.stringify({ type: "FeatureCollection", features }, null, 2);
            }

            function toWKTBatch(geoms) {
                const parts = geoms.map(g => {
                    const ring = g.rings[0];
                    let s = "POLYGON((";
                    for (let i = 0; i < ring.length; i += 2) {
                        s += ring[i] + " " + ring[i+1] + (i === ring.length - 2 ? "" : ",");
                    }
                    return s + "))";
                });
                return geoms.length === 1 ? parts[0] : \`GEOMETRYCOLLECTION(\${parts.join(",")})\`;
            }

            function toKMLBatch(geoms) {
                const placemarks = geoms.map(g => {
                    const coords = g.rings[0];
                    const chunks = [];
                    for (let i = 0; i < coords.length; i += 2) chunks.push(\`\${coords[i]},\${coords[i+1]},0\`);
                    return \`
    <Placemark>
      <name>\${g.siteId}</name>
      <styleUrl>#msn_line</styleUrl>
      <Polygon>
        <tessellate>1</tessellate>
        <outerBoundaryIs>
          <LinearRing><coordinates>\${chunks.join(" ")}</coordinates></LinearRing>
        </outerBoundaryIs>
      </Polygon>
    </Placemark>\`;
                }).join("");

                return \`<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Maps</name>
    <Style id="msn_line">
      <LineStyle><color>ff000000</color><width>4</width></LineStyle>
      <PolyStyle><color>40007cf5</color></PolyStyle>
    </Style>
    <Folder>
      <name>fat_region</name>
      <open>0</open>
      \${placemarks}
    </Folder>
  </Document>
</kml>\`;
            }
        `;

        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));

        let currentResults = { geojson: '', wkt: '', kml: '' };
        let activeFormat = 'geojson';
        let map = null;
        let geojsonLayer = null;
        let lastSiteId = 'batch_export';

        const ui = {
            input: document.getElementById('jsonInput'),
            output: document.getElementById('outputCode'),
            processBtn: document.getElementById('processBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            fileUpload: document.getElementById('fileUpload'),
            status: document.getElementById('statusIndicator'),
            metrics: document.getElementById('performanceMetrics'),
            errorModal: document.getElementById('errorModal'),
            errorMsg: document.getElementById('errorMessage'),
            mapContainer: document.getElementById('mapContainer'),
            codeContainer: document.getElementById('codeContainer')
        };

        function initMap() {
            if (map) return;
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        ui.fileUpload.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                ui.input.value = event.target.result;
                processEngine();
            };
            reader.readAsText(file);
        };

        window.loadSample = (itemCount) => {
            const items = [];
            for(let j=0; j<itemCount; j++) {
                const coords = [];
                const siteId = `SITE-${1000 + j}`;
                const centerLon = -122.4194 + (Math.random() - 0.5) * 5;
                const centerLat = 37.7749 + (Math.random() - 0.5) * 5;
                for(let i=0; i<10; i++) {
                    const angle = (i / 10) * Math.PI * 2;
                    coords.push({
                        longitude: parseFloat((Math.cos(angle) * 0.1 + centerLon).toFixed(6)),
                        latitude: parseFloat((Math.sin(angle) * 0.1 + centerLat).toFixed(6))
                    });
                }
                items.push({ siteId, multiCoordinates: coords });
            }
            ui.input.value = JSON.stringify({ items }, null, 2);
        };

        window.showFormat = (fmt) => {
            activeFormat = fmt;
            
            if (fmt === 'map') {
                ui.codeContainer.classList.add('hidden');
                ui.mapContainer.classList.remove('hidden');
                initMap();
                updateMapData();
                setTimeout(() => map.invalidateSize(), 100);
            } else {
                ui.mapContainer.classList.add('hidden');
                ui.codeContainer.classList.remove('hidden');
                ui.output.textContent = currentResults[fmt] || "No data processed yet.";
            }

            document.querySelectorAll('.view-tab').forEach(btn => {
                const isMatch = btn.dataset.format === fmt;
                btn.className = isMatch 
                    ? "view-tab px-4 py-1.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-700"
                    : "view-tab px-4 py-1.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 hover:bg-slate-200";
            });

            ui.downloadBtn.disabled = !currentResults.geojson;
        };

        function updateMapData() {
            if (!map || !currentResults.geojson) return;
            if (geojsonLayer) map.removeLayer(geojsonLayer);

            const data = JSON.parse(currentResults.geojson);
            geojsonLayer = L.geoJSON(data, {
                style: { color: "#2563eb", weight: 2, fillOpacity: 0.2 },
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`<strong>Zone:</strong> ${feature.properties.Zone}`);
                }
            }).addTo(map);

            if (data.features.length > 0) {
                map.fitBounds(geojsonLayer.getBounds(), { padding: [20, 20] });
            }
        }

        window.copyToClipboard = () => {
            const text = activeFormat === 'map' ? currentResults.geojson : ui.output.textContent;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        };

        window.downloadOutput = () => {
            const fmt = activeFormat === 'map' ? 'geojson' : activeFormat;
            const content = currentResults[fmt];
            if (!content) return;
            const mimes = { geojson: 'application/geo+json', wkt: 'text/plain', kml: 'application/vnd.google-earth.kml+xml' };
            const ext = { geojson: 'geojson', wkt: 'txt', kml: 'kml' };
            const blob = new Blob([content], { type: mimes[fmt] });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `File Export.${ext[fmt]}`;
            a.click();
            URL.revokeObjectURL(url);
        };

        async function processEngine() {
            const raw = ui.input.value.trim();
            if (!raw) return;

            ui.processBtn.disabled = true;
            ui.processBtn.textContent = "Processing Batch...";
            ui.status.textContent = "ENGINE BUSY";

            try {
                const formats = ['geojson', 'wkt', 'kml'];
                for (const fmt of formats) {
                    const result = await runTask(raw, fmt);
                    currentResults[fmt] = result.data;
                    lastSiteId = result.firstSiteId;
                    ui.metrics.textContent = `Processed ${result.count} items in ${result.ms}ms`;
                }
                showFormat(activeFormat);
            } catch (err) {
                ui.errorMsg.textContent = err.message || err;
                ui.errorModal.classList.remove('hidden');
            } finally {
                ui.processBtn.disabled = false;
                ui.processBtn.textContent = "Process Batch Geometry";
                ui.status.textContent = "ENGINE READY";
            }
        }

        ui.processBtn.onclick = processEngine;

        function runTask(input, format) {
            return new Promise((resolve, reject) => {
                const onMsg = (e) => {
                    if (e.data.success) resolve(e.data);
                    else reject(e.data.error);
                    worker.removeEventListener('message', onMsg);
                };
                worker.addEventListener('message', onMsg);
                worker.postMessage({ input, format });
            });
        }

        window.closeError = () => ui.errorModal.classList.add('hidden');

        loadSample(3);
    </script>
</body>
</html>
