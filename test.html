<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق اختبار React</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseSDK = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, setDoc, onSnapshot, setLogLevel
        };
    </script>

    <style>
        /* Reset and Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            -moz-tab-size: 4;
            tab-size: 4;
            font-family: 'Inter', sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        body { 
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: #f3f4f6; /* gray-100 */
            color: #111827; /* gray-900 */
        }

        .dark body {
            background-color: #030712; /* gray-950 (darker) */
            color: #f9fafb; /* gray-50 */
        }
        
        /* LTR/RTL specific styles */
        input[type="url"].force-ltr, 
        input[type="number"].force-ltr, /* Text input for topic will now follow page direction */
        textarea.force-ltr { 
            direction: ltr; 
            text-align: start; 
        }
        pre.dir-ltr { direction: ltr; text-align: left; }


        /* Animations */
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
          animation: shake 0.5s ease-in-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
         @keyframes fadeInUpSlight { 
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }


        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; } /* gray-200 */
        .dark ::-webkit-scrollbar-track { background: #374151; } /* gray-700 */
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } /* gray-400 */
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; } /* gray-500 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
        .dark ::-webkit-scrollbar-thumb:hover { background: #4b5563; } /* gray-600 */

        /* Utility Classes (mimicking Tailwind) */
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .z-40 { z-index: 40; }
        .z-50 { z-index: 50; }
        .top-4 { top: 1rem; }
        .left-4 { left: 1rem; }
        .right-4 { right: 1rem; }

        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        
        .m-auto { margin: auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .my-8 { margin-top: 2rem; margin-bottom: 2rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mt-10 { margin-top: 2.5rem; }
        .mr-1 { margin-right: 0.25rem; } /* For LTR */
        .ml-1 { margin-left: 0.25rem; } /* For LTR */
        .mr-2 { margin-right: 0.5rem; } /* For LTR */
        .ml-2 { margin-left: 0.5rem; } /* For LTR */
        .ms-2 { margin-inline-start: 0.5rem; } /* Logical property */


        .w-full { width: 100%; }
        .w-11 { width: 2.75rem; }
        .w-4 { width: 1rem; }
        .w-6 { width: 1.5rem; }
        .w-8 { width: 2rem; }
        .w-24 { width: 6rem; }
        .w-32 { width: 8rem; }
        .h-6 { height: 1.5rem; }
        .h-4 { height: 1rem; }
        .h-12 { height: 3rem; }
        .h-24 { height: 6rem; }
        .h-32 { height: 8rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-lg { max-width: 32rem; }
        .max-w-xl { max-width: 36rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-3xl { max-width: 48rem; }
        .min-h-screen { min-height: 100vh; }

        .flex { display: flex; }
        .inline-flex { display: inline-flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .justify-start { justify-content: flex-start; }
        .flex-grow { flex-grow: 1; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .space-x-2 > :not([hidden]) ~ :not([hidden]) { --tw-space-x-reverse: 0; margin-right: calc(0.5rem * var(--tw-space-x-reverse)); margin-left: calc(0.5rem * calc(1 - var(--tw-space-x-reverse)));}
        .rtl .space-x-2 > :not([hidden]) ~ :not([hidden]) { --tw-space-x-reverse: 1; }
        .space-y-2 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem; }
        .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }


        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        
        .rounded-full { border-radius: 9999px; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }

        .border { border-width: 1px; }
        .border-2 { border-width: 2px; }
        .border-dashed { border-style: dashed; }
        .border-b { border-bottom-width: 1px; }
        .border-t { border-top-width: 1px; }
        
        .border-gray-200 { border-color: #e5e7eb; }
        .dark .border-gray-700 { border-color: #374151; }
        .dark .border-gray-600 { border-color: #4b5563; }
        .border-purple-300 { border-color: #c4b5fd; }
        .dark .border-purple-600 { border-color: #7c3aed; }
        .border-blue-300 { border-color: #93c5fd; }
        .dark .border-blue-600 { border-color: #2563eb; }
        .border-green-300 { border-color: #6ee7b7; }
        .dark .border-green-600 { border-color: #059669; }
        .border-yellow-200 { border-color: #fef08a; }
        .dark .border-yellow-700 { border-color: #a16207; }
        
        .shadow { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .dark .shadow { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.3), 0 1px 2px 0 rgba(0,0,0,0.15); }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .dark .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0,0,0,0.2); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.15); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -2px rgba(0,0,0,0.2); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); }
        .dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.25); }
        .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06); }
        .dark .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.2); }

        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .italic { font-style: italic; }
        .underline { text-decoration-line: underline; }
        .no-underline { text-decoration-line: none; }

        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }

        .text-white { color: #fff; }
        .text-gray-800 { color: #1f2937; }
        .dark .text-gray-100 { color: #f3f4f6; }
        .dark .text-gray-200 { color: #e5e7eb; }
        .dark .text-gray-300 { color: #d1d5db; }
        .dark .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-indigo-700 { color: #4338ca; }
        .dark .text-indigo-400 { color: #a5b4fc; }
        .text-indigo-600 { color: #4f46e5; }
        .dark .text-indigo-300 { color: #a5b4fc; } 
        .text-purple-700 { color: #6d28d9; }
        .dark .text-purple-300 { color: #c4b5fd; }
        .text-blue-700 { color: #1d4ed8; }
        .dark .text-blue-300 { color: #93c5fd; }
        .text-green-700 { color: #047857; }
        .dark .text-green-200 { color: #a7f3d0; }
        .dark .text-green-300 { color: #6ee7b7; }
        .text-red-700 { color: #b91c1c; }
        .dark .text-red-200 { color: #fecaca; }
        .dark .text-red-400 { color: #f87171; }
        .text-yellow-700 { color: #b45309; }
        .dark .text-yellow-200 { color: #fef08a; }
        .text-yellow-800 { color: #92400e; }
        .text-orange-700 { color: #c2410c; }
        .dark .text-orange-300 { color: #fdba74; }
        .text-orange-600 { color: #ea580c; }
        .dark .text-orange-200 { color: #fed7aa; }
        .text-lime-700 { color: #4d7c0f; }
        .dark .text-lime-300 { color: #bef264; }
        .text-sky-700 { color: #0369a1; }
        .dark .text-sky-300 { color: #7dd3fc; }
        .text-rose-700 { color: #be123c; }
        .dark .text-rose-300 { color: #fda4af; }


        .bg-white { background-color: #fff; }
        .dark .bg-gray-800 { background-color: #1f2937; }
        .dark .bg-gray-700 { background-color: #374151; }
        .dark .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-50 { background-color: #f9fafb; }
        .dark .bg-gray-700-opacity-50 { background-color: rgba(55, 65, 81, 0.5); } 
        .bg-gray-100 { background-color: #f3f4f6; }
        .dark .bg-gray-100 { background-color: #111827; } 
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-300 { background-color: #d1d5db; }
        .bg-gray-400 { background-color: #9ca3af; }
        .dark .bg-gray-500 { background-color: #6b7280; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-purple-50 { background-color: #faf5ff; }
        .dark .bg-purple-900-opacity-20 { background-color: rgba(76, 29, 149, 0.2); } 
        .bg-blue-50 { background-color: #eff6ff; }
        .dark .bg-blue-900-opacity-20 { background-color: rgba(30, 58, 138, 0.2); } 
        .bg-green-50 { background-color: #f0fdf4; }
        .dark .bg-green-900-opacity-20 { background-color: rgba(6, 78, 59, 0.2); } 
        .dark .bg-green-800-opacity-30 { background-color: rgba(6, 95, 70, 0.3); }
        .bg-yellow-50 { background-color: #fffbeb; }
        .dark .bg-yellow-900-opacity-30 { background-color: rgba(120,53,15,0.3); } 
        .dark .bg-yellow-700-opacity-30 { background-color: rgba(180,83,9,0.3); }
        .bg-indigo-50 { background-color: #eef2ff; }
        .dark .bg-indigo-900-opacity-20 { background-color: rgba(49,46,129,0.2); } 
        .bg-orange-50 { background-color: #fff7ed; }
        .dark .bg-orange-900-opacity-30 { background-color: rgba(124,45,18,0.3); } 
        .bg-lime-50 { background-color: #f7fee7; }
        .dark .bg-lime-900-opacity-30 { background-color: rgba(54,83,20,0.3); } 
        .bg-sky-50 { background-color: #f0f9ff; }
        .dark .bg-sky-900-opacity-30 { background-color: rgba(3,105,161,0.3); } 
        .bg-rose-50 { background-color: #fff1f2; }
        .dark .bg-rose-900-opacity-30 { background-color: rgba(159,18,57,0.3); } 
        .bg-teal-100 { background-color: #ccfbf1;}
        .dark .bg-teal-800-opacity-30 { background-color: rgba(19, 78, 74, 0.3); }
        .bg-blue-100 { background-color: #dbeafe; }
        .dark .bg-blue-800-opacity-30 { background-color: rgba(30, 64, 175, 0.3); }
        .bg-yellow-100 { background-color: #fef9c3; }
        .dark .bg-yellow-800-opacity-30 { background-color: rgba(133, 77, 14, 0.3); }
        
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-from), var(--tw-gradient-to)); }
        .from-green-100 { --tw-gradient-from: #d1fae5; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(209,250,229,0)); }
        .dark .from-green-900-opacity-30 { --tw-gradient-from: rgba(6,78,59,0.3); --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(6,78,59,0));}
        .via-blue-100 { --tw-gradient-stops: var(--tw-gradient-from), #dbeafe, var(--tw-gradient-to, rgba(219,234,254,0)); }
        .dark .via-blue-900-opacity-30 { --tw-gradient-stops: var(--tw-gradient-from), rgba(30,58,138,0.3), var(--tw-gradient-to, rgba(30,58,138,0));}
        .to-purple-200 { --tw-gradient-to: #e9d5ff; }
        .dark .to-purple-900-opacity-30 { --tw-gradient-to: rgba(76,29,149,0.3); }

        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-purple-500 { --tw-gradient-from: #a855f7; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(168,85,247,0)); }
        .to-pink-500 { --tw-gradient-to: #ec4899; }
        
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .dark .hover\:bg-gray-700:hover { background-color: #374151; }
        .hover\:bg-gray-300:hover { background-color: #d1d5db; }
        .dark .hover\:bg-gray-500:hover { background-color: #6b7280; }
        .hover\:from-purple-600:hover { --tw-gradient-from: #9333ea; }
        .hover\:to-pink-600:hover { --tw-gradient-to: #db2777; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-green-600:hover { background-color: #059669; }
        .hover\:bg-yellow-600:hover { background-color: #ca8a04; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-red-600:hover { background-color: #dc2626; }
        .dark .hover\:bg-red-400:hover { background-color: #f87171; }
        .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .dark .hover\:bg-indigo-600:hover { background-color: #4f46e5; }
        .hover\:bg-teal-600:hover { background-color: #0d9488; }
        .hover\:bg-orange-600:hover { background-color: #ea580c; }
        .hover\:bg-gray-800:hover { background-color: #1f2937; }
        .hover\:bg-blue-900:hover { background-color: #1e3a8a; }
        .hover\:bg-emerald-600:hover { background-color: #059669; }
        .hover\:bg-rose-600:hover { background-color: #e11d48; }
        .hover\:bg-lime-600:hover { background-color: #65a30d; }
        .hover\:bg-cyan-600:hover { background-color: #0891b2; }
        .hover\:bg-purple-500:hover { background-color: #a855f7; }


        .opacity-0 { opacity: 0; }
        .opacity-70 { opacity: 0.7; }
        .disabled\:opacity-50:disabled { opacity: 0.5; }

        .transform { transform: translateX(0) translateY(0) rotate(0) skewX(0) skewY(0) scaleX(1) scaleY(1); }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .hover\:scale-102:hover { transform: scale(1.02); }
        .hover\:scale-110:hover { transform: scale(1.1); }
        .hover\:-translate-y-0\.5:hover { transform: translateY(-0.125rem); }
        .hover\:-translate-y-px:hover { transform: translateY(-1px); }

        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4,0,0.2,1); transition-duration: 150ms; }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4,0,0.2,1); transition-duration: 150ms; }
        .duration-200 { transition-duration: 200ms; }
        .duration-300 { transition-duration: 300ms; }
        .ease-in-out { transition-timing-function: cubic-bezier(0.4,0,0.2,1); }
        
        .cursor-not-allowed { cursor: not-allowed; }
        .cursor-pointer { cursor: pointer; }
        .cursor-wait { cursor: wait; }

        .whitespace-nowrap { white-space: nowrap; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        .break-words { overflow-wrap: break-word; }
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .overflow-x-auto { overflow-x: auto; }
        .hidden { display: none; }

        .list-none { list-style-type: none; }
        .list-disc { list-style-type: disc; }
        .list-inside { list-style-position: inside; }

        .ring-2 { box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .ring-offset-2 { --tw-ring-offset-width: 2px; box-shadow: 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color), var(--tw-ring-shadow); }
        .dark .ring-offset-gray-800 { --tw-ring-offset-color: #1f2937; }
        .ring-green-700 { --tw-ring-color: #047857; }
        .dark .ring-green-500 { --tw-ring-color: #10b981; }
        .ring-red-700 { --tw-ring-color: #b91c1c; }
        .dark .ring-red-500 { --tw-ring-color: #ef4444; }
        .focus\:ring-purple-500:focus { --tw-ring-color: #a855f7; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .focus\:border-purple-500:focus { border-color: #a855f7; }
        .focus\:ring-yellow-500:focus { --tw-ring-color: #f59e0b; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .dark .focus\:ring-yellow-400:focus { --tw-ring-color: #facc15; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .focus\:border-blue-500:focus { border-color: #3b82f6; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: #6366f1; box-shadow: 0 0 0 2px var(--tw-ring-color); }
        .focus\:border-indigo-500:focus { border-color: #6366f1; }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        
        /* Responsive utilities */
        @media (min-width: 640px) { /* sm */
            .sm\:flex-row { flex-direction: row; }
            .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .sm\:w-auto { width: auto; }
            .sm\:inline { display: inline; }
            .sm\:my-8 { margin-top: 2rem; margin-bottom: 2rem; }
            .sm\:p-8 { padding: 2rem; }
            .sm\:text-2xl { font-size: 1.5rem; line-height: 2rem; }
            .sm\:text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
            .sm\:text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        }
        @media (min-width: 1024px) { /* lg */
            .lg\:col-span-1 { grid-column: span 1 / span 1; }
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        /* Specific component styles that were harder to translate directly or for clarity */
        .results-list li {
            border-bottom-width: 1px;
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .dark .results-list li {
            border-color: #4b5563; /* gray-600 */
        }
        html:not(.dark) .results-list li {
             border-color: #e5e7eb; /* gray-200 */
        }
        .results-list li:last-child {
            border-bottom-width: 0;
            margin-bottom: 0;
        }

        .llm-output-card {
            background-color: #f9fafb;
            padding: 0.75rem; 
            border-radius: 0.5rem; 
            margin-top: 1rem; 
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        .dark .llm-output-card {
            background-color: #1f2937; 
            border: 1px solid #374151; 
        }
        .llm-output-card h4 {
            font-weight: 600; 
            margin-bottom: 0.5rem;
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <div id="root" class="max-w-3xl mx-auto my-4 sm:my-8 px-2 sm:px-4"></div> 

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React; 

        // Default questions data (in Arabic) 
        const defaultQuestions = [
           { question: "ما هي عاصمة العراق؟", options: ["بغداد", "دمشق", "عمان", "بيروت"], correctAnswer: "بغداد" },
           { question: "من هو مؤلف كتاب كليلة ودمنة؟", options: ["الجاحظ", "ابن المقفع", "المتنبي", "ابن خلدون"], correctAnswer: "ابن المقفع" },
           { question: "في أي قارة تقع مصر؟", options: ["آسيا", "أفريقيا", "أوروبا", "أمريكا الشمالية"], correctAnswer: "أفريقيا" },
           { question: "ما هو أطول نهر في العالم؟", options: ["النيل", "الأمازون", "المسيسيبي", "دجلة"], correctAnswer: "النيل" },
           { question: "كم عدد أضلاع المسدس؟", options: ["5", "6", "7", "8"], correctAnswer: "6" }
        ];
        
        // Translations object (remains the same)
        const translations = {
            ar: {
                appTitle: "تطبيق اختبار React",
                settings: "الإعدادات",
                darkMode: "المظهر الداكن",
                defaultAIGeneratedQuestions: "عدد أسئلة الذكاء الاصطناعي الافتراضي:",
                defaultQuizLength: "طول الاختبار الافتراضي:",
                soundEffects: "المؤثرات الصوتية",
                appLanguage: "لغة التطبيق:",
                arabic: "العربية",
                english: "English", 
                resetAllSettings: "إعادة ضبط الكل",
                close: "إغلاق",
                importOrGenerateQuestions: "استيراد أو توليد الأسئلة",
                generateWithAI: "✨ توليد أسئلة باستخدام الذكاء الاصطناعي:",
                enterTopicPlaceholder: "أدخل موضوعاً (مثال: تاريخ العراق الحديث)",
                generateQuestionsButton: "توليد الأسئلة ✨",
                generatingButton: "جاري التوليد...",
                difficultyLevel: "مستوى الصعوبة:",
                easy: "سهل",
                medium: "متوسط",
                hard: "صعب",
                generateStudyMaterialButton: "مواد دراسية ✨",
                generatingStudyMaterialButton: "مواد دراسية...",
                generateQuizChallengeButton: "تحدي الاختبار ✨",
                generatingQuizChallengeButton: "تحدي...",
                generateRelatedTopicsButton: "مواضيع ذات صلة ✨",
                generatingRelatedTopicsButton: "مواضيع...",
                generateOpenEndedQuestionsButton: "أسئلة مفتوحة ✨",
                generatingOpenEndedQuestionsButton: "أسئلة مفتوحة...",
                revealCommonMisconceptionsButton: "كشف المفاهيم الخاطئة ✨",
                generatingMisconceptionsButton: "مفاهيم خاطئة...",
                studyMaterialTitle: "مادة دراسية:",
                quizChallengeTitle: "تحدي الاختبار:",
                relatedTopicsTitle: "مواضيع مقترحة:",
                openEndedQuestionsTitle: "أسئلة مفتوحة:",
                commonMisconceptionsTitle: "مفاهيم خاطئة شائعة:",
                importFromAPI: "من رابط API:",
                apiURLExample: "أدخل رابط API (JSON)",
                importButton: "استيراد",
                loadingButton: "جاري التحميل...",
                importFromFile: "من ملف JSON:",
                clickToUpload: "اضغط للتحميل",
                dragDropHere: "أو اسحب ملفك هنا",
                jsonOnly: "JSON فقط",
                useDefaultQuestionsButton: "استخدام الأسئلة الافتراضية",
                showJSONFormatInfo: "عرض معلومات تنسيق JSON المطلوب",
                hideJSONFormatInfo: "إخفاء معلومات تنسيق JSON المطلوب",
                requiredJSONFormat: "تنسيق JSON المطلوب:",
                recentlyUploaded: "الأسئلة المحملة مؤخراً:",
                useButton: "استخدام",
                startQuizTitle: "بدء الاختبار",
                questionSource: "مصدر الأسئلة:",
                defaultSource: "الأسئلة الافتراضية",
                apiSource: "API خارجي",
                fileSource: "ملف محلي",
                historySource: "ملف محمل مؤخراً",
                llmSource: "الذكاء الاصطناعي ✨",
                llmReviewSource: "مراجعة الذكاء الاصطناعي ✨",
                undefinedSource: "غير محدد",
                totalAvailableQuestions: "إجمالي الأسئلة المتاحة:",
                chooseNumberOfQuestions: "اختر عدد الأسئلة:",
                startQuizButton: "بدء الاختبار",
                quizEndedTitle: "انتهى الاختبار!",
                yourScore: "درجتك:",
                percentage: "النسبة المئوية:",
                from: "من",
                answerDetails: "تفاصيل الإجابات:",
                yourAnswer: "إجابتك:",
                notAnswered: "(لم تتم الإجابة)",
                correctAnswerLabel: "الإجابة الصحيحة:",
                analyzePerformanceButton: "تحليل أداء الاختبار ✨",
                analyzingPerformanceButton: "تحليل الأداء...",
                generateReviewQuestionsResultsButton: "أسئلة مراجعة ✨",
                generatingReviewQuestionsResultsButton: "أسئلة مراجعة...",
                extractKeyConceptsButton: "استخلاص المفاهيم ✨",
                extractingKeyConceptsButton: "مفاهيم رئيسية...",
                personalizedStudyTipsButton: "نصائح دراسية ✨",
                generatingStudyTipsButton: "نصائح دراسية...",
                showCommonMisconceptionsResultsButton: "عرض المفاهيم الخاطئة ✨",
                generatingMisconceptionsResultsButton: "مفاهيم خاطئة...",
                createStudyPlanButton: "إنشاء خطة دراسية ✨",
                creatingStudyPlanButton: "إنشاء خطة...",
                summarizeWeaknessesButton: "لخص نقاط ضعفي ✨",
                summarizingWeaknessesButton: "تلخيص الضعف...",
                quizAnalysisTitle: "تحليل الأداء:",
                reviewQuestionsTitle: "أسئلة المراجعة:",
                startReviewQuizButton: "بدء اختبار المراجعة",
                keyConceptsTitle: "المفاهيم الرئيسية:",
                personalizedStudyTipsTitle: "نصائح دراسية مخصصة:",
                suggestedStudyPlanTitle: "خطة دراسية مقترحة:",
                weaknessSummaryTitle: "ملخص نقاط الضعف:",
                newQuizButton: "اختبار جديد",
                retrySameQuizButton: "إعادة نفس الاختبار",
                errorLoadingQuestion: "حدث خطأ غير متوقع في تحميل السؤال.",
                backToStartButton: "العودة إلى البداية",
                questionLabel: "السؤال",
                scoreLabel: "النتيجة:",
                requestHintButton: "طلب تلميح ✨",
                requestingHintButton: "جاري طلب تلميح...",
                hintTitle: "تلميح:",
                correctAnswerFeedback: "✔️ إجابة صحيحة!",
                incorrectAnswerFeedback: "❌ إجابة خاطئة! الإجابة الصحيحة هي:",
                explainAnswerButton: "شرح الإجابة ✨",
                explainingAnswerButton: "جاري الشرح...",
                createFlashcardButton: "إنشاء بطاقة مراجعة ✨",
                creatingFlashcardButton: "إنشاء بطاقة...",
                flashcardTitle: "بطاقة المراجعة:",
                explanationTitle: "الشرح:",
                explainSimplyButton: "اشرح ببساطة ✨",
                simplifyingButton: "تبسيط...",
                realWorldExamplesButton: "أمثلة واقعية ✨",
                generatingExamplesButton: "أمثلة...",
                followUpQuestionButton: "سؤال متابعة ✨",
                generatingFollowUpButton: "سؤال متابعة...",
                giveAnalogyButton: "أعطني تشبيهًا ✨",
                generatingAnalogyButton: "تشبيه...",
                analogyTitle: "تشبيه:",
                simplifiedExplanationTitle: "شرح مبسط:",
                realWorldExamplesTitle: "أمثلة من الواقع:",
                followUpQuestionTitle: "سؤال المتابعة:",
                cancelQuizButton: "إلغاء الاختبار",
                areYouSure: "هل أنت متأكد؟",
                yes: "نعم",
                no: "لا",
                showResultButton: "إظهار النتيجة",
                nextQuestionButton: "السؤال التالي",
                errorInvalidURL: "الرابط الذي أدخلته غير صالح",
                errorEnterURL: "الرجاء إدخال رابط صحيح",
                errorLoadingAPI: "فشل تحميل الرابط، الحالة:",
                errorImportingAPI: "حدث خطأ أثناء استيراد الأسئلة من الرابط:",
                errorJSONOnly: "يرجى تحميل ملف بصيغة JSON فقط",
                errorReadingFile: "خطأ في قراءة أو تحليل الملف:",
                errorReadingFileGeneric: "حدث خطأ أثناء قراءة الملف",
                errorEnterTopicForQuestions: "الرجاء إدخال موضوع لتوليد الأسئلة.",
                errorGeneratingQuestions: "خطأ في توليد الأسئلة:",
                errorGeneratingQuestionsRetry: "جاري المحاولة...",
                errorGeneratingQuestionsFinal: "يرجى التأكد من وضوح الموضوع.",
                errorNoActiveQuestionForExplanation: "لا يوجد سؤال حالي للشرح.",
                errorGettingExplanation: "خطأ في الحصول على الشرح:",
                errorNoActiveQuestionForHint: "لا يوجد سؤال حالي للتلميح.",
                errorGettingHint: "خطأ في الحصول على تلميح:",
                errorNeedBaseExplanation: "يجب عرض الشرح الأساسي أولاً.",
                errorGettingEli5: "خطأ في الحصول على الشرح المبسّط:",
                errorNoActiveQuestionForExamples: "لا يوجد سؤال حالي لعرض أمثلة له.",
                errorGettingExamples: "خطأ في الحصول على أمثلة واقعية:",
                errorEnterTopicOrLLMQuizForMisconceptions: "الرجاء إدخال موضوع أولاً، أو يجب أن يكون الاختبار الحالي مولداً بواسطة الذكاء الاصطناعي.",
                errorNoTopicForMisconceptions: "لم يتم تحديد موضوع للمفاهيم الخاطئة.",
                errorGeneratingMisconceptions: "خطأ في توليد المفاهيم الخاطئة:",
                errorNeedBaseExplanationForAnalogy: "يجب عرض الشرح الأساسي أولاً لإنشاء تشبيه.",
                errorGettingAnalogy: "خطأ في الحصول على التشبيه:",
                errorNoActiveQuestionForFlashcard: "لا يوجد سؤال حالي لإنشاء بطاقة مراجعة.",
                errorCreatingFlashcard: "خطأ في إنشاء بطاقة المراجعة:",
                errorCreatingStudyPlan: "خطأ في إنشاء خطة دراسية:",
                greatPerformanceNoWeaknesses: "أداء رائع! لا توجد نقاط ضعف لتلخيصها.",
                errorSummarizingWeaknesses: "خطأ في تلخيص نقاط الضعف:",
                errorAnalyzingPerformance: "خطأ في تحليل الأداء:",
                errorGeneratingStudyMaterial: "خطأ في توليد مواد دراسية:",
                errorGeneratingQuizChallenge: "خطأ في توليد تحدي الاختبار:",
                errorGeneratingRelatedTopics: "خطأ في توليد المواضيع ذات الصلة:",
                errorInvalidTopicsGenerated: "لم يتمكن Gemini من توليد مواضيع صالحة.",
                errorNoIncorrectToReview: "لم تجب على أي سؤال بشكل خاطئ.",
                errorGeneratingReviewQuestions: "خطأ في توليد أسئلة المراجعة:",
                errorNoQuestionsToExtractConcepts: "لا توجد أسئلة لاستخلاص المفاهيم.",
                errorExtractingConcepts: "خطأ في استخلاص المفاهيم:",
                errorEnterTopicForOpenEnded: "الرجاء إدخال موضوع لتوليد أسئلة مفتوحة.",
                errorGeneratingOpenEnded: "خطأ في توليد أسئلة مفتوحة:",
                errorNoActiveQuestionForFollowUp: "لا يوجد سؤال حالي لسؤال متابعة.",
                errorGeneratingFollowUp: "خطأ في توليد سؤال متابعة:",
                errorGeneratingPersonalizedStudyTips: "خطأ في توليد نصائح دراسية:",
                errorNoQuestionsAvailable: "لا توجد أسئلة متاحة.",
                errorInvalidNumberOfQuestions: "عدد أسئلة غير صالح.",
                errorNumberTooLarge: "العدد المطلوب ({val1}) أكبر من المتاح ({val2}).",
                settingsResetNotification: "تمت إعادة ضبط الإعدادات إلى الافتراضيات.",
                quizResultPerfect: "🎉 أداء رائع! لقد أجبت على جميع الأسئلة بشكل صحيح 👏",
                quizResultGreat: "💪 عمل جيد! واصل التعلم والمثابرة",
                quizResultGood: "👍 نتيجة جيدة، لكن يمكنك التحسن أكثر",
                quizResultKeepTrying: "✨ لا تيأس، كل محاولة تقربك من النجاح",
                questionsGeneratedSuccessLLM: "تم توليد {count} أسئلة بمستوى {difficulty} بنجاح! ✨",
                fileImportedSuccess: "تم استيراد \"{fileName}\" بنجاح!",
                questionsImportedSuccessAPI: "تم استيراد الأسئلة من الرابط بنجاح!",
                loadedFromHistory: "تم تحميل الأسئلة من \"{fileName}\"",
                usingDefaultQuestions: "تم العودة إلى الأسئلة الافتراضية",
                reviewQuestionsGeneratedSuccess: "تم توليد أسئلة المراجعة بنجاح! ✨",
                reason: "السبب",
                requestBlocked: "تم حظر الطلب بسبب",
                errorGeminiProcessing: "لم يتمكن Gemini من معالجة الطلب.",
                errorEnterTopicForStudyMaterial: "الرجاء إدخال موضوع لتوليد مواد دراسية.",
                errorEnterTopicForChallenge: "الرجاء إدخال موضوع لتوليد تحدي الاختبار.",
                errorEnterTopicForRelated: "الرجاء إدخال موضوع لتوليد مواضيع ذات صلة.",
                errorPlayingSound: "خطأ في تشغيل الصوت:",
                errorInvalidSoundParams: "معلمات الصوت غير صالحة.",
                factOfTheDay: "✨ معلومة اليوم ✨",
                generatingFact: "جاري جلب معلومة اليوم...",
                challengeMeButton: "✨ تحداني بسؤال أصعب!",
                generatingChallengeQuestionButton: "جاري توليد سؤال التحدي...",
                challengeQuestionTitle: "سؤال التحدي الصعب!",
                submitChallengeAnswer: "إرسال إجابة التحدي",
                closeChallenge: "إغلاق التحدي",
                challengeCorrect: "🎉 صحيح! لقد تغلبت على التحدي!",
                challengeIncorrect: "للأسف، الإجابة خاطئة. الإجابة الصحيحة هي:",
                noChallengeQuestion: "لم يتم تحميل سؤال التحدي.",
                errorNoTopicForChallenge: "الرجاء تحديد موضوع أولاً لسؤال التحدي.",
                userProfilePanelTitle: "ملف المستخدم",
                displayNameLabel: "اسم العرض:",
                displayNamePlaceholder: "أدخل اسم العرض الخاص بك",
                photoURLLabel: "رابط صورة الملف الشخصي:",
                photoURLPlaceholder: "https://example.com/avatar.png",
                saveProfileButton: "حفظ الملف الشخصي",
                profileSavedSuccess: "تم حفظ الملف الشخصي بنجاح!",
                errorSavingProfile: "خطأ في حفظ الملف الشخصي:",
                errorLoadingProfile: "خطأ في تحميل الملف الشخصي. استخدام الافتراضيات.",
                profile: "الملف الشخصي",
                errorSavingSettings: "خطأ في حفظ الإعدادات:",
                errorLoadingSettings: "خطأ في تحميل الإعدادات. استخدام الافتراضيات."
            },
            en: {
                appTitle: "React Quiz App",
                settings: "Settings",
                darkMode: "Dark Mode",
                defaultAIGeneratedQuestions: "Default AI Questions Count:",
                defaultQuizLength: "Default Quiz Length:",
                soundEffects: "Sound Effects",
                appLanguage: "App Language:",
                arabic: "العربية",
                english: "English",
                resetAllSettings: "Reset All Settings",
                close: "Close",
                importOrGenerateQuestions: "Import or Generate Questions",
                generateWithAI: "✨ Generate Questions with AI:",
                enterTopicPlaceholder: "Enter a topic (e.g., Modern History of Iraq)",
                generateQuestionsButton: "Generate Questions ✨",
                generatingButton: "Generating...",
                difficultyLevel: "Difficulty Level:",
                easy: "Easy",
                medium: "Medium",
                hard: "Hard",
                generateStudyMaterialButton: "Study Material ✨",
                generatingStudyMaterialButton: "Study Material...",
                generateQuizChallengeButton: "Quiz Challenge ✨",
                generatingQuizChallengeButton: "Challenge...",
                generateRelatedTopicsButton: "Related Topics ✨",
                generatingRelatedTopicsButton: "Topics...",
                generateOpenEndedQuestionsButton: "Open-ended Questions ✨",
                generatingOpenEndedQuestionsButton: "Open-ended...",
                revealCommonMisconceptionsButton: "Reveal Common Misconceptions ✨",
                generatingMisconceptionsButton: "Misconceptions...",
                studyMaterialTitle: "Study Material:",
                quizChallengeTitle: "Quiz Challenge:",
                relatedTopicsTitle: "Suggested Topics:",
                openEndedQuestionsTitle: "Open-ended Questions:",
                commonMisconceptionsTitle: "Common Misconceptions:",
                importFromAPI: "From API URL:",
                apiURLExample: "Enter API URL (JSON)",
                importButton: "Import",
                loadingButton: "Loading...",
                importFromFile: "From JSON File:",
                clickToUpload: "Click to Upload",
                dragDropHere: "or drag and drop",
                jsonOnly: "JSON only",
                useDefaultQuestionsButton: "Use Default Questions",
                showJSONFormatInfo: "Show Required JSON Format",
                hideJSONFormatInfo: "Hide Required JSON Format",
                requiredJSONFormat: "Required JSON Format:",
                recentlyUploaded: "Recently Uploaded:",
                useButton: "Use",
                startQuizTitle: "Start Quiz",
                questionSource: "Question Source:",
                defaultSource: "Default Questions",
                apiSource: "External API",
                fileSource: "Local File",
                historySource: "Recently Uploaded File",
                llmSource: "Artificial Intelligence ✨",
                llmReviewSource: "AI Review ✨",
                undefinedSource: "Undefined",
                totalAvailableQuestions: "Total Available Questions:",
                chooseNumberOfQuestions: "Choose number of questions:",
                startQuizButton: "Start Quiz",
                quizEndedTitle: "Quiz Ended!",
                yourScore: "Your Score:",
                percentage: "Percentage:",
                from: "of",
                answerDetails: "Answer Details:",
                yourAnswer: "Your Answer:",
                notAnswered: "(Not answered)",
                correctAnswerLabel: "Correct Answer:",
                analyzePerformanceButton: "Analyze Quiz Performance ✨",
                analyzingPerformanceButton: "Analyzing Performance...",
                generateReviewQuestionsResultsButton: "Review Questions ✨",
                generatingReviewQuestionsResultsButton: "Review Questions...",
                extractKeyConceptsButton: "Extract Key Concepts ✨",
                extractingKeyConceptsButton: "Key Concepts...",
                personalizedStudyTipsButton: "Personalized Study Tips ✨",
                generatingStudyTipsButton: "Study Tips...",
                showCommonMisconceptionsResultsButton: "Show Common Misconceptions ✨",
                generatingMisconceptionsResultsButton: "Misconceptions...",
                createStudyPlanButton: "Create Study Plan ✨",
                creatingStudyPlanButton: "Creating Plan...",
                summarizeWeaknessesButton: "Summarize My Weaknesses ✨",
                summarizingWeaknessesButton: "Summarizing...",
                quizAnalysisTitle: "Performance Analysis:",
                reviewQuestionsTitle: "Review Questions:",
                startReviewQuizButton: "Start Review Quiz",
                keyConceptsTitle: "Key Concepts:",
                personalizedStudyTipsTitle: "Personalized Study Tips:",
                suggestedStudyPlanTitle: "Suggested Study Plan:",
                weaknessSummaryTitle: "Weakness Summary:",
                newQuizButton: "New Quiz",
                retrySameQuizButton: "Retry Same Quiz",
                errorLoadingQuestion: "Unexpected error loading question.",
                backToStartButton: "Back to Start",
                questionLabel: "Question",
                scoreLabel: "Score:",
                requestHintButton: "Request Hint ✨",
                requestingHintButton: "Requesting Hint...",
                hintTitle: "Hint:",
                correctAnswerFeedback: "✔️ Correct Answer!",
                incorrectAnswerFeedback: "❌ Incorrect! The correct answer is:",
                explainAnswerButton: "Explain Answer ✨",
                explainingAnswerButton: "Explaining...",
                createFlashcardButton: "Create Flashcard ✨",
                creatingFlashcardButton: "Creating Card...",
                flashcardTitle: "Flashcard:",
                explanationTitle: "Explanation:",
                explainSimplyButton: "Explain Simply ✨",
                simplifyingButton: "Simplifying...",
                realWorldExamplesButton: "Real-world Examples ✨",
                generatingExamplesButton: "Examples...",
                followUpQuestionButton: "Follow-up Question ✨",
                generatingFollowUpButton: "Follow-up...",
                giveAnalogyButton: "Give me an Analogy ✨",
                generatingAnalogyButton: "Analogy...",
                analogyTitle: "Analogy:",
                simplifiedExplanationTitle: "Simplified Explanation:",
                realWorldExamplesTitle: "Real-world Examples:",
                followUpQuestionTitle: "Follow-up Question:",
                cancelQuizButton: "Cancel Quiz",
                areYouSure: "Are you sure?",
                yes: "Yes",
                no: "No",
                showResultButton: "Show Result",
                nextQuestionButton: "Next Question",
                errorInvalidURL: "The URL you entered is invalid.",
                errorEnterURL: "Please enter a valid URL.",
                errorLoadingAPI: "Failed to load from URL, status:",
                errorImportingAPI: "Error importing questions from URL:",
                errorJSONOnly: "Please upload a JSON file only.",
                errorReadingFile: "Error reading or parsing the file:",
                errorReadingFileGeneric: "Error reading the file.",
                errorEnterTopicForQuestions: "Please enter a topic to generate questions.",
                errorGeneratingQuestions: "Error generating questions:",
                errorGeneratingQuestionsRetry: "Retrying...",
                errorGeneratingQuestionsFinal: "Please ensure the topic is clear.",
                errorNoActiveQuestionForExplanation: "No current question to get an explanation for.",
                errorGettingExplanation: "Error getting explanation:",
                errorNoActiveQuestionForHint: "No current question for a hint.",
                errorGettingHint: "Error getting hint:",
                errorNeedBaseExplanation: "Base explanation must be shown first.",
                errorGettingEli5: "Error getting simplified explanation:",
                errorNoActiveQuestionForExamples: "No current question to show examples for.",
                errorGettingExamples: "Error getting real-world examples:",
                errorEnterTopicOrLLMQuizForMisconceptions: "Please enter a topic first, or the current quiz must be AI-generated.",
                errorNoTopicForMisconceptions: "No topic identified for misconceptions.",
                errorGeneratingMisconceptions: "Error generating common misconceptions:",
                errorNeedBaseExplanationForAnalogy: "Base explanation must be shown first to generate an analogy.",
                errorGettingAnalogy: "Error getting analogy:",
                errorNoActiveQuestionForFlashcard: "No current question to create a flashcard for.",
                errorCreatingFlashcard: "Error creating flashcard:",
                errorCreatingStudyPlan: "Error creating study plan:",
                greatPerformanceNoWeaknesses: "Great performance! No weaknesses to summarize.",
                errorSummarizingWeaknesses: "Error summarizing weaknesses:",
                errorAnalyzingPerformance: "Error analyzing performance:",
                errorGeneratingStudyMaterial: "Error generating study material:",
                errorGeneratingQuizChallenge: "Error generating quiz challenge:",
                errorGeneratingRelatedTopics: "Error generating related topics:",
                errorInvalidTopicsGenerated: "Gemini could not generate valid topics.",
                errorNoIncorrectToReview: "You answered all questions correctly.",
                errorGeneratingReviewQuestions: "Error generating review questions:",
                errorNoQuestionsToExtractConcepts: "No questions to extract concepts from.",
                errorExtractingConcepts: "Error extracting key concepts:",
                errorEnterTopicForOpenEnded: "Please enter a topic to generate open-ended questions.",
                errorGeneratingOpenEnded: "Error generating open-ended questions:",
                errorNoActiveQuestionForFollowUp: "No current question for a follow-up.",
                errorGeneratingFollowUp: "Error generating follow-up question:",
                errorGeneratingPersonalizedStudyTips: "Error generating personalized study tips:",
                errorNoQuestionsAvailable: "No questions available.",
                errorInvalidNumberOfQuestions: "Invalid number of questions.",
                errorNumberTooLarge: "Requested number ({val1}) is larger than available ({val2}).",
                settingsResetNotification: "Settings have been reset to defaults.",
                quizResultPerfect: "🎉 Awesome performance! You answered all questions correctly 👏",
                quizResultGreat: "💪 Good job! Keep learning and persevering",
                quizResultGood: "👍 Good result, but you can improve further",
                quizResultKeepTrying: "✨ Don't give up, every attempt brings you closer to success",
                questionsGeneratedSuccessLLM: "{count} {difficulty} questions generated successfully! ✨",
                fileImportedSuccess: "\"{fileName}\" imported successfully!",
                questionsImportedSuccessAPI: "Questions imported from URL successfully!",
                loadedFromHistory: "Loaded questions from \"{fileName}\"",
                usingDefaultQuestions: "Switched to default questions",
                reviewQuestionsGeneratedSuccess: "Review questions generated successfully! ✨",
                reason: "Reason",
                requestBlocked: "Request blocked due to",
                errorGeminiProcessing: "Gemini could not process the request.",
                errorEnterTopicForStudyMaterial: "Please enter a topic to generate study material.",
                errorEnterTopicForChallenge: "Please enter a topic to generate a quiz challenge.",
                errorEnterTopicForRelated: "Please enter a topic to generate related topics.",
                errorPlayingSound: "Error playing sound:",
                errorInvalidSoundParams: "Invalid sound parameters.",
                factOfTheDay: "✨ Fact of the Day ✨",
                generatingFact: "Fetching fact of the day...",
                challengeMeButton: "✨ Challenge Me with a Harder Question!",
                generatingChallengeQuestionButton: "Generating Challenge Question...",
                challengeQuestionTitle: "Tough Challenge Question!",
                submitChallengeAnswer: "Submit Challenge Answer",
                closeChallenge: "Close Challenge",
                challengeCorrect: "🎉 Correct! You beat the challenge!",
                challengeIncorrect: "Unfortunately, that's incorrect. The correct answer was:",
                noChallengeQuestion: "Challenge question not loaded.",
                errorNoTopicForChallenge: "Please set a topic first for the challenge question.",
                userProfilePanelTitle: "User Profile",
                displayNameLabel: "Display Name:",
                displayNamePlaceholder: "Enter your display name",
                photoURLLabel: "Profile Picture URL:",
                photoURLPlaceholder: "https://example.com/avatar.png",
                saveProfileButton: "Save Profile",
                profileSavedSuccess: "Profile saved successfully!",
                errorSavingProfile: "Error saving profile:",
                errorLoadingProfile: "Error loading profile. Using defaults.",
                profile: "Profile",
                errorSavingSettings: "Error saving settings:",
                errorLoadingSettings: "Error loading settings. Using defaults."
            }
        };


        // Main Quiz App Component
        const QuizApp = () => {
          // State variables
          const [questions, setQuestions] = useState(defaultQuestions);
          const [currentIndex, setCurrentIndex] = useState(0);
          const [score, setScore] = useState(0);
          const [showResult, setShowResult] = useState(false);
          const [feedback, setFeedback] = useState(null);
          const [isNextVisible, setIsNextVisible] = useState(false);
          
          const [selectedQuestions, setSelectedQuestions] = useState([]);
          const [quizStarted, setQuizStarted] = useState(false);
          const [apiUrl, setApiUrl] = useState('');
          const [isLoading, setIsLoading] = useState(false); 
          const [error, setError] = useState('');
          const [sourceType, setSourceType] = useState('default');
          const [showFormatInfo, setShowFormatInfo] = useState(false);
          const [notification, setNotification] = useState({ message: '', type: '' });
          const [showCancelConfirm, setShowCancelConfirm] = useState(false);
          const [userAnswers, setUserAnswers] = useState({});
          const [uploadedFileHistory, setUploadedFileHistory] = useState([]);

          // LLM integration states
          const [llmTopic, setLlmTopic] = useState('');
          const [isGeneratingQuestions, setIsGeneratingQuestions] = useState(false);
          const [explanation, setExplanation] = useState('');
          const [isExplaining, setIsExplaining] = useState(false);
          const [quizAnalysis, setQuizAnalysis] = useState('');
          const [isAnalyzingQuiz, setIsAnalyzingQuiz] = useState(false);
          const [studyMaterial, setStudyMaterial] = useState('');
          const [isGeneratingStudyMaterial, setIsGeneratingStudyMaterial] = useState(false);
          const [quizChallenge, setQuizChallenge] = useState('');
          const [isGeneratingChallenge, setIsGeneratingChallenge] = useState(false);
          const [relatedTopics, setRelatedTopics] = useState([]);
          const [isGeneratingRelatedTopics, setIsGeneratingRelatedTopics] = useState(false);
          const [reviewQuestions, setReviewQuestions] = useState([]);
          const [isGeneratingReviewQuestions, setIsGeneratingReviewQuestions] = useState(false);
          const [keyConcepts, setKeyConcepts] = useState('');
          const [isExtractingConcepts, setIsExtractingConcepts] = useState(false);
          const [openEndedQuestions, setOpenEndedQuestions] = useState('');
          const [isGeneratingOpenEndedQuestions, setIsGeneratingOpenEndedQuestions] = useState(false);
          const [followUpQuestion, setFollowUpQuestion] = useState('');
          const [isGeneratingFollowUpQuestion, setIsGeneratingFollowUpQuestion] = useState(false);
          const [personalizedStudyTips, setPersonalizedStudyTips] = useState('');
          const [isGeneratingStudyTips, setIsGeneratingStudyTips] = useState(false);
          const [hint, setHint] = useState('');
          const [isGeneratingHint, setIsGeneratingHint] = useState(false);
          const [eli5Explanation, setEli5Explanation] = useState('');
          const [isGeneratingEli5, setIsGeneratingEli5] = useState(false);
          const [realWorldApplications, setRealWorldApplications] = useState('');
          const [isGeneratingApplications, setIsGeneratingApplications] = useState(false);
          const [difficulty, setDifficulty] = useState('medium'); 
          const [commonMisconceptions, setCommonMisconceptions] = useState('');
          const [isGeneratingMisconceptions, setIsGeneratingMisconceptions] = useState(false);
          const [analogy, setAnalogy] = useState('');
          const [isGeneratingAnalogy, setIsGeneratingAnalogy] = useState(false);
          const [flashcard, setFlashcard] = useState(''); 
          const [isGeneratingFlashcard, setIsGeneratingFlashcard] = useState(false);
          const [studyPlan, setStudyPlan] = useState('');
          const [isGeneratingStudyPlan, setIsGeneratingStudyPlan] = useState(false);
          const [weaknessSummary, setWeaknessSummary] = useState('');
          const [isGeneratingWeaknessSummary, setIsGeneratingWeaknessSummary] = useState(false);

          // Settings State
          const [theme, setTheme] = useState('light'); 
          const [showSettings, setShowSettings] = useState(false);
          const [defaultAiQuestions, setDefaultAiQuestions] = useState(5); 
          const [defaultQuizLength, setDefaultQuizLength] = useState(5); 
          const [soundEffects, setSoundEffects] = useState(true); 
          const [appLanguage, setAppLanguage] = useState('ar'); 

          const [numQuestions, setNumQuestions] = useState(defaultQuizLength);

          // New LLM Feature States
          const [factOfTheDay, setFactOfTheDay] = useState('');
          const [isGeneratingFact, setIsGeneratingFact] = useState(false);
          const [challengeQuestion, setChallengeQuestion] = useState(null); 
          const [isGeneratingChallengeQuestion, setIsGeneratingChallengeQuestion] = useState(false);
          const [showChallengeQuestionModal, setShowChallengeQuestionModal] = useState(false);
          const [challengeQuestionAnswer, setChallengeQuestionAnswer] = useState('');
          const [challengeQuestionFeedback, setChallengeQuestionFeedback] = useState(null); 

          // User Profile State
          const [showUserProfilePanel, setShowUserProfilePanel] = useState(false);
          const [userProfile, setUserProfile] = useState({ displayName: '', photoURL: '' });
          const [isSavingProfile, setIsSavingProfile] = useState(false);


          // Firebase State
          const [fbApp, setFbApp] = useState(null);
          const [fbAuth, setFbAuth] = useState(null);
          const [fbDb, setFbDb] = useState(null);
          const [userId, setUserId] = useState(null);
          const [settingsLoaded, setSettingsLoaded] = useState(false);
          const [profileLoaded, setProfileLoaded] = useState(false);


          // Translation function
          const t = useCallback((key, params = {}) => {
            let string = translations[appLanguage]?.[key] || translations.en[key] || key; 
            if (typeof string === 'string') { 
                Object.keys(params).forEach(paramKey => {
                    string = string.replace(`{${paramKey}}`, params[paramKey]);
                });
            }
            return string;
          }, [appLanguage]);


          // Update numQuestions if defaultQuizLength changes and no quiz is active
          useEffect(() => {
            if (!quizStarted) { 
                const newNum = parseInt(defaultQuizLength);
                if (!isNaN(newNum) && newNum > 0) {
                    setNumQuestions(newNum);
                } else {
                    setNumQuestions(5); 
                }
            }
          }, [defaultQuizLength, quizStarted]);


          // Function to shuffle an array
          const shuffleArray = (array) => {
             if (!array || array.length === 0) return [];
             let currentIndex = array.length, randomIndex;
             const shuffledArray = [...array];
             while (currentIndex !== 0) {
               randomIndex = Math.floor(Math.random() * currentIndex);
               currentIndex--;
               [shuffledArray[currentIndex], shuffledArray[randomIndex]] = [shuffledArray[randomIndex], shuffledArray[currentIndex]];
             }
             return shuffledArray;
          };

          // Effect for theme and language direction
          useEffect(() => {
            const htmlEl = document.documentElement;
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark');
            }
            htmlEl.lang = appLanguage;
            htmlEl.dir = appLanguage === 'ar' ? 'rtl' : 'ltr';
            document.title = t('appTitle');
          }, [theme, appLanguage, t]); 

          useEffect(() => {
             if (questions && questions.length > 0 && !quizStarted) { 
               const maxQ = questions ? questions.length : 0;
               let newNumQ = parseInt(defaultQuizLength);

               if (isNaN(newNumQ) || newNumQ <= 0) {
                   newNumQ = 5; 
               }
               
               if (maxQ > 0) {
                   newNumQ = Math.min(newNumQ, maxQ);
               } else {
                   newNumQ = 0; 
               }
               setNumQuestions(newNumQ);
             }
          }, [questions, defaultQuizLength, quizStarted]);


          const activeCurrentQuestion = useMemo(() => {
            if (quizStarted && !showResult && selectedQuestions.length > currentIndex && currentIndex >= 0) {
                return selectedQuestions[currentIndex];
            }
            return null;
          }, [quizStarted, showResult, selectedQuestions, currentIndex]);

          const currentOptions = useMemo(() => {
            if (activeCurrentQuestion && activeCurrentQuestion.options) {
                return shuffleArray(activeCurrentQuestion.options);
            }
            return [];
          }, [activeCurrentQuestion]);

           // Firebase Initialization and Auth
           useEffect(() => {
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, setLogLevel } = window.firebaseSDK;
            
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            if (!firebaseConfig) {
                console.error("Firebase config not found.");
                setError("Firebase configuration is missing. Settings cannot be saved.");
                setSettingsLoaded(true); 
                setProfileLoaded(true);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                setLogLevel('debug'); 

                setFbApp(app);
                setFbAuth(auth);
                setFbDb(db);

                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
                return () => unsubscribe();
            } catch (e) {
                console.error("Firebase initialization error:", e);
                setError("Failed to initialize Firebase. Settings cannot be saved.");
                setSettingsLoaded(true); 
                setProfileLoaded(true);
            }
        }, []);

        // Save settings to Firestore
        const saveSettingsToFirestore = useCallback(async (settingsToSave) => {
            if (fbDb && userId) {
                const { doc, setDoc } = window.firebaseSDK;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const settingsRef = doc(fbDb, `artifacts/${appId}/users/${userId}/userSettings`, "appPreferences");
                try {
                    await setDoc(settingsRef, settingsToSave, { merge: true });
                    console.log("Settings saved to Firestore:", settingsToSave);
                } catch (error) {
                    console.error("Error saving settings to Firestore:", error);
                    showNotification(t('errorSavingSettings'), 'error'); 
                }
            }
        }, [fbDb, userId, t, showNotification]);

        // Load settings from Firestore
        useEffect(() => {
            if (fbDb && userId && !settingsLoaded) { 
                const { doc, getDoc } = window.firebaseSDK;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const settingsRef = doc(fbDb, `artifacts/${appId}/users/${userId}/userSettings`, "appPreferences");
                
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const loadedSettings = docSnap.data();
                        setTheme(loadedSettings.theme || 'light');
                        setDefaultAiQuestions(loadedSettings.defaultAiQuestions || 5);
                        setDefaultQuizLength(loadedSettings.defaultQuizLength || 5);
                        setSoundEffects(loadedSettings.soundEffects === undefined ? true : loadedSettings.soundEffects);
                        setAppLanguage(loadedSettings.appLanguage || 'ar');
                        console.log("Settings loaded from Firestore:", loadedSettings);
                    } else {
                        console.log("No settings found in Firestore, using defaults and saving them.");
                        saveSettingsToFirestore({ theme, defaultAiQuestions, defaultQuizLength, soundEffects, appLanguage });
                    }
                    setSettingsLoaded(true); 
                }).catch(error => {
                    console.error("Error loading settings from Firestore:", error);
                    setError(t('errorLoadingSettings')); 
                    setSettingsLoaded(true); 
                });
            }
        }, [fbDb, userId, settingsLoaded, saveSettingsToFirestore, theme, defaultAiQuestions, defaultQuizLength, soundEffects, appLanguage, t]); 
        
        // Save user profile to Firestore
        const saveUserProfileToFirestore = useCallback(async (profileData) => {
            if (fbDb && userId) {
                const { doc, setDoc } = window.firebaseSDK;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const profileRef = doc(fbDb, `artifacts/${appId}/users/${userId}/userProfile`, "profileInfo");
                setIsSavingProfile(true);
                try {
                    await setDoc(profileRef, profileData, { merge: true });
                    setUserProfile(profileData); 
                    showNotification(t('profileSavedSuccess'), 'success');
                } catch (error) {
                    console.error("Error saving profile to Firestore:", error);
                    setError(t('errorSavingProfile') + ` ${error.message}`);
                } finally {
                    setIsSavingProfile(false);
                }
            }
        }, [fbDb, userId, t, showNotification]);

        // Load user profile from Firestore
        useEffect(() => {
            if (fbDb && userId && !profileLoaded) {
                const { doc, getDoc } = window.firebaseSDK;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const profileRef = doc(fbDb, `artifacts/${appId}/users/${userId}/userProfile`, "profileInfo");

                getDoc(profileRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const loadedProfile = docSnap.data();
                        setUserProfile({
                            displayName: loadedProfile.displayName || '',
                            photoURL: loadedProfile.photoURL || ''
                        });
                        console.log("Profile loaded from Firestore:", loadedProfile);
                    } else {
                        console.log("No profile found in Firestore, using defaults.");
                        saveUserProfileToFirestore({ displayName: '', photoURL: '' });
                    }
                    setProfileLoaded(true);
                }).catch(error => {
                    console.error("Error loading profile from Firestore:", error);
                    setError(t('errorLoadingProfile'));
                    setProfileLoaded(true);
                });
            }
        }, [fbDb, userId, profileLoaded, saveUserProfileToFirestore, t]);


        // --- Utility and Core Functions ---
        const showNotification = useCallback((message, type = 'info', duration = 3000) => {
            setNotification({ message, type });
            setTimeout(() => { setNotification({ message: '', type: '' }); }, duration);
        }, []);

        const validateQuestions = useCallback((data) => {
             if (!Array.isArray(data)) throw new Error(t('errorInvalidDataArray'));
             if (data.length === 0) throw new Error(t('errorNoQuestionsReceived'));
             const invalidQuestions = data.filter(q => !q.question || !Array.isArray(q.options) || q.options.length < 2 || !q.correctAnswer || !q.options.includes(q.correctAnswer));
             if (invalidQuestions.length > 0) {
               const firstInvalid = invalidQuestions[0];
               let detail = t('errorInvalidQuestionDetail', { question: firstInvalid.question ? String(firstInvalid.question).substring(0, 30)+'...' : t('undefined') });
               throw new Error(t('errorFoundInvalidQuestions', {count: invalidQuestions.length, detail}));
             }
             return true;
          }, [t]);

          const clearAllLLMOutputs = useCallback(() => {
            setExplanation(''); setQuizAnalysis(''); setStudyMaterial('');
            setQuizChallenge(''); setRelatedTopics([]); setReviewQuestions([]);
            setKeyConcepts(''); setOpenEndedQuestions(''); setFollowUpQuestion('');
            setPersonalizedStudyTips(''); setHint(''); setEli5Explanation('');
            setRealWorldApplications(''); setCommonMisconceptions('');
            setAnalogy(''); setFlashcard(''); 
            setStudyPlan(''); setWeaknessSummary(''); 
            setFactOfTheDay(''); setChallengeQuestion(null); setChallengeQuestionFeedback(null); setChallengeQuestionAnswer('');
          }, []);
          
          // Sound playing function using Tone.js
          const playSound = useCallback((params) => {
            if (!soundEffects || !window.Tone) return; 
            try {
                Tone.start(); 
                const synth = new Tone.Synth({
                    oscillator: { type: params.oscillatorType || 'sine' },
                    envelope: {
                        attack: params.envelope?.attack ?? 0.005,
                        decay: params.envelope?.decay ?? 0.1,
                        sustain: params.envelope?.sustain ?? 0.3,
                        release: params.envelope?.release ?? 1,
                    },
                    volume: params.volume ?? -10, 
                }).toDestination();
                synth.triggerAttackRelease(params.frequency || "C4", params.duration || "8n", Tone.now());
            } catch (e) {
                console.error("Error playing sound with Tone.js:", e);
                setError(t('errorPlayingSound') + ` ${e.message}`);
            }
          }, [soundEffects, t]);


          const fetchQuestionsFromApi = useCallback(async () => {
             if (!apiUrl.trim()) { setError(t('errorEnterURL')); return; }
             try { new URL(apiUrl); } catch (_) { setError(t('errorInvalidURL')); return; }
             setIsLoading(true); 
             setError(''); setNotification({ message: '', type: '' });
             setLlmTopic(''); clearAllLLMOutputs();
             try {
               const response = await fetch(apiUrl);
               if (!response.ok) throw new Error(t('errorLoadingAPI') + ` ${response.status}`);
               const data = await response.json();
               validateQuestions(data);
               setQuestions(data);
               setSourceType('api');
               showNotification(t('questionsImportedSuccessAPI'), 'success');
             } catch (err) { console.error("Error fetching data:", err); setError(t('errorImportingAPI') + ` ${err.message}`); }
             finally { setIsLoading(false); }
          }, [apiUrl, t, validateQuestions, clearAllLLMOutputs, showNotification]);

          const handleFileUpload = useCallback((event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== "application/json" && !file.name.endsWith('.json')) {
              setError(t('errorJSONOnly'));
              if (event.target) event.target.value = null; return;
            }
            setIsLoading(true); 
            setError(''); setNotification({ message: '', type: '' });
            setLlmTopic(''); clearAllLLMOutputs();
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const content = e.target.result;
                const data = JSON.parse(content);
                validateQuestions(data);
                const newHistoryEntry = { name: file.name, questions: data };
                setUploadedFileHistory(prevHistory => {
                    const updatedHistory = [newHistoryEntry, ...prevHistory.filter(item => item.name !== file.name)];
                    return updatedHistory.slice(0, 5);
                });
                setQuestions(data);
                setSourceType('file');
                showNotification(t('fileImportedSuccess', { fileName: file.name }), 'success');
              } catch (err) { console.error("Error reading file:", err); setError(t('errorReadingFile') + ` ${err.message}`); }
              finally { setIsLoading(false); if (event.target) event.target.value = null; }
            };
            reader.onerror = () => { setError(t('errorReadingFileGeneric')); setIsLoading(false); if (event.target) event.target.value = null; };
            reader.readAsText(file);
          }, [t, validateQuestions, clearAllLLMOutputs, showNotification]);

          const loadFromHistory = useCallback((fileName) => {
            const historyItem = uploadedFileHistory.find(item => item.name === fileName);
            if (historyItem) {
                setQuestions(historyItem.questions);
                setSourceType('history');
                setError(''); setNotification({ message: '', type: '' });
                showNotification(t('loadedFromHistory', { fileName }), 'info');
                setApiUrl(''); setLlmTopic(''); clearAllLLMOutputs();
            }
          }, [uploadedFileHistory, t, clearAllLLMOutputs, showNotification]);

          const useDefaultQuestions = useCallback(() => {
            setQuestions(defaultQuestions);
            setSourceType('default');
            setError(''); setNotification({ message: '', type: '' });
            showNotification(t('usingDefaultQuestions'), 'info');
            setApiUrl(''); setLlmTopic(''); clearAllLLMOutputs();
          }, [t, clearAllLLMOutputs, showNotification]);

          // --- Gemini API Call Helper ---
          const callGeminiAPI = useCallback(async (prompt, config = { responseMimeType: "text/plain" }) => {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: config
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Gemini API Error Response:", result);
                let errorMessage = t('errorGeminiProcessing');
                if (result.error && result.error.message) {
                    errorMessage += ` ${t('reason')}: ${result.error.message}`;
                } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                    errorMessage += ` ${t('requestBlocked')}: ${result.promptFeedback.blockReason}`;
                     if (result.promptFeedback.blockReasonMessage) {
                        errorMessage += ` - ${result.promptFeedback.blockReasonMessage}`;
                     }
                }
                throw new Error(errorMessage);
            }
          }, [t]);


          // --- LLM Feature Functions ---
          const generateQuestionsFromLLM = useCallback(async () => {
            if (!llmTopic.trim()) { setError(t('errorEnterTopicForQuestions')); return; }
            setIsGeneratingQuestions(true); setError(''); clearAllLLMOutputs();
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const numAiQs = defaultAiQuestions > 0 ? defaultAiQuestions : 5; 
                    const prompt = `Generate ${numAiQs} multiple-choice quiz questions in Arabic about "${llmTopic}" at a "${difficulty}" difficulty level. Each question should have 4 options, and one of them MUST be the correct answer, which must be EXPLICITLY present in the options array. Provide the output as a JSON array of objects, where each object has "question" (string), "options" (array of strings), and "correctAnswer" (string).`;
                    const schema = {
                        type: "ARRAY", items: {
                            type: "OBJECT", properties: {
                                "question": { "type": "STRING" },
                                "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "correctAnswer": { "type": "STRING" }
                            }, required: ["question", "options", "correctAnswer"]
                        }
                    };
                    const jsonString = await callGeminiAPI(prompt, { responseMimeType: "application/json", responseSchema: schema });
                    const generatedQuestions = JSON.parse(jsonString);
                    validateQuestions(generatedQuestions);
                    setQuestions(generatedQuestions); setSourceType('llm');
                    showNotification(t('questionsGeneratedSuccessLLM', {count: generatedQuestions.length, difficulty: t(difficulty)}), 'success');
                    setIsGeneratingQuestions(false); return;
                } catch (err) {
                    console.error(`Error generating questions (retry ${i + 1}):`, err);
                    setError(t('errorGeneratingQuestions') + ` ${err.message}. ${i < maxRetries -1 ? t('errorGeneratingQuestionsRetry') : t('errorGeneratingQuestionsFinal')}`);
                }
            }
            setIsGeneratingQuestions(false);
          }, [llmTopic, difficulty, defaultAiQuestions, t, callGeminiAPI, validateQuestions, clearAllLLMOutputs, showNotification]);

          const getExplanationFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion) { setError(t('errorNoActiveQuestionForExplanation')); return; }
            setIsExplaining(true); setExplanation(''); setEli5Explanation(''); setRealWorldApplications(''); setAnalogy(''); setFlashcard(''); setError('');
            const { question, options, correctAnswer } = activeCurrentQuestion;
            const userAnswer = userAnswers[currentIndex];
            const isCorrect = userAnswer === correctAnswer;
            let prompt = `اشرح السؤال التالي وإجابته الصحيحة باللغة العربية. السؤال: "${question}" الخيارات: ${options.join(', ')}. الإجابة الصحيحة: "${correctAnswer}".`;
            if (!isCorrect) prompt += ` إجابة المستخدم كانت: "${userAnswer}". وضح لماذا إجابة المستخدم خاطئة ولماذا الإجابة الصحيحة هي الصواب.`;
            else prompt += ` وضح لماذا هذه هي الإجابة الصحيحة.`;
            try {
                const explanationText = await callGeminiAPI(prompt);
                setExplanation(explanationText);
            } catch (err) { setError(t('errorGettingExplanation') + ` ${err.message}`); }
            finally { setIsExplaining(false); }
          }, [activeCurrentQuestion, userAnswers, currentIndex, t, callGeminiAPI]);

          const getHintFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion || feedback) return; 
            setIsGeneratingHint(true); setHint(''); setError('');
            const { question, options } = activeCurrentQuestion;
            const prompt = `للسؤال التالي باللغة العربية: "${question}" مع الخيارات: "${options.join(', ')}", قدم تلميحًا واحدًا دقيقًا وموجزًا باللغة العربية يساعد المستخدم على استنتاج الإجابة الصحيحة دون كشفها مباشرةً.`;
            try {
                const hintText = await callGeminiAPI(prompt);
                setHint(hintText);
            } catch (err) { setError(t('errorGettingHint') + ` ${err.message}`); }
            finally { setIsGeneratingHint(false); }
          }, [activeCurrentQuestion, feedback, t, callGeminiAPI]);

          const getEli5ExplanationFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion || !explanation) { setError(t('errorNeedBaseExplanation')); return; }
            setIsGeneratingEli5(true); setEli5Explanation(''); setError('');
            const { question, correctAnswer } = activeCurrentQuestion;
            const prompt = `اشرح المفهوم الأساسي للسؤال التالي: "${question}" (الإجابة الصحيحة: "${correctAnswer}") بكلمات بسيطة جداً، كما لو كنت تشرح لطفل عمره 5 سنوات. الشرح الأصلي كان: "${explanation}". قدم الشرح المبسّط باللغة العربية.`;
            try {
                const eli5Text = await callGeminiAPI(prompt);
                setEli5Explanation(eli5Text);
            } catch (err) { setError(t('errorGettingEli5') + ` ${err.message}`); }
            finally { setIsGeneratingEli5(false); }
          }, [activeCurrentQuestion, explanation, t, callGeminiAPI]);

          const getRealWorldApplicationsFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion) { setError(t('errorNoActiveQuestionForExamples')); return; }
            setIsGeneratingApplications(true); setRealWorldApplications(''); setError('');
            const { question } = activeCurrentQuestion;
            const prompt = `بالنسبة لسؤال الاختبار التالي باللغة العربية: "${question}"، ما هي 2-3 تطبيقات أو أمثلة واقعية موجزة للمفهوم الرئيسي الذي يختبره؟ قدم الإجابة باللغة العربية.`;
            try {
                const appText = await callGeminiAPI(prompt);
                setRealWorldApplications(appText);
            } catch (err) { setError(t('errorGettingExamples') + ` ${err.message}`); }
            finally { setIsGeneratingApplications(false); }
          }, [activeCurrentQuestion, t, callGeminiAPI]);
          
          const generateCommonMisconceptionsFromLLM = useCallback(async () => {
            if (!llmTopic.trim() && !(sourceType === 'llm' && selectedQuestions.length > 0)) { 
                setError(t('errorEnterTopicOrLLMQuizForMisconceptions')); 
                return; 
            }
            setIsGeneratingMisconceptions(true); setCommonMisconceptions(''); setError('');
            
            let topicToUse = llmTopic.trim();
            if (!topicToUse && sourceType === 'llm' && selectedQuestions.length > 0) {
                topicToUse = selectedQuestions[0].question.substring(0,30) + "... (مستنتج)"; 
            }
            if (!topicToUse) { 
                 setError(t('errorNoTopicForMisconceptions'));
                 setIsGeneratingMisconceptions(false);
                 return;
            }

            const prompt = `اذكر 2-3 مفاهيم خاطئة شائعة حول موضوع "${topicToUse}". لكل مفهوم خاطئ، قدم شرحًا موجزًا باللغة العربية يوضح لماذا هو خاطئ وما هو الصحيح.`;
            try {
                const misconceptionsText = await callGeminiAPI(prompt);
                setCommonMisconceptions(misconceptionsText);
            } catch (err) { setError(t('errorGeneratingMisconceptions') + ` ${err.message}`); }
            finally { setIsGeneratingMisconceptions(false); }
          }, [llmTopic, sourceType, selectedQuestions, t, callGeminiAPI]);

          const getAnalogyFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion || !explanation) { setError(t('errorNeedBaseExplanationForAnalogy')); return; }
            setIsGeneratingAnalogy(true); setAnalogy(''); setError('');
            const { question, correctAnswer } = activeCurrentQuestion;
            const prompt = `للمفهوم الذي تم اختباره في سؤال الاختبار التالي باللغة العربية: "${question}" (الإجابة الصحيحة: "${correctAnswer}")، والذي تم شرحه كـ: "${explanation}", قدم تشبيهًا بسيطًا واحدًا باللغة العربية للمساعدة في فهمه بشكل أفضل.`;
            try {
                const analogyText = await callGeminiAPI(prompt);
                setAnalogy(analogyText);
            } catch (err) { setError(t('errorGettingAnalogy') + ` ${err.message}`); }
            finally { setIsGeneratingAnalogy(false); }
          }, [activeCurrentQuestion, explanation, t, callGeminiAPI]);

          const generateFlashcardFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion) { setError(t('errorNoActiveQuestionForFlashcard')); return; }
            setIsGeneratingFlashcard(true); setFlashcard(''); setError('');
            const { question, correctAnswer } = activeCurrentQuestion;
            const prompt = `أنشئ بطاقة مراجعة موجزة باللغة العربية لسؤال الاختبار التالي. نسّقها مع "الوجه الأمامي:" و "الوجه الخلفي:".\nالسؤال: "${question}"\nالإجابة الصحيحة: "${correctAnswer}"`;
            try {
                const flashcardText = await callGeminiAPI(prompt);
                setFlashcard(flashcardText); 
            } catch (err) { setError(t('errorCreatingFlashcard') + ` ${err.message}`); }
            finally { setIsGeneratingFlashcard(false); }
          }, [activeCurrentQuestion, t, callGeminiAPI]);

          const generateStudyPlanFromLLM = useCallback(async () => {
            setIsGeneratingStudyPlan(true); setStudyPlan(''); setError('');
            let prompt = `بناءً على أداء المستخدم في الاختبار التالي، قم بإنشاء خطة دراسية موجزة وقابلة للتنفيذ باللغة العربية.`;
            prompt += `\n\nنتائج الاختبار:\n`;
            prompt += `إجمالي الأسئلة: ${selectedQuestions.length}\n`;
            prompt += `الإجابات الصحيحة: ${score}\n`;
            prompt += `الإجابات الخاطئة: ${selectedQuestions.length - score}\n`;
            if (llmTopic.trim()) {
                prompt += `موضوع الاختبار: "${llmTopic}"\n`;
            } else if (sourceType === 'llm' && selectedQuestions.length > 0) {
                prompt += `موضوع الاختبار (مستنتج): "${selectedQuestions[0].question.substring(0,30)}..."\n`;
            }
            const incorrectQs = selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer);
            if (incorrectQs.length > 0) {
                prompt += `\nالأسئلة التي تمت الإجابة عليها بشكل غير صحيح (لتركيز الخطة عليها):\n`;
                incorrectQs.forEach((q, i) => { prompt += `- ${q.question}\n`; });
            }
            prompt += `\nالخطة يجب أن تتضمن 2-3 خطوات أو اقتراحات محددة.`;
            try {
                const planText = await callGeminiAPI(prompt);
                setStudyPlan(planText);
            } catch (err) { setError(t('errorCreatingStudyPlan') + ` ${err.message}`); }
            finally { setIsGeneratingStudyPlan(false); }
          }, [selectedQuestions, score, userAnswers, llmTopic, sourceType, t, callGeminiAPI]);

          const summarizeWeaknessesFromLLM = useCallback(async () => {
            setIsGeneratingWeaknessSummary(true); setWeaknessSummary(''); setError('');
            const incorrectQs = selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer);
            if (incorrectQs.length === 0) {
                showNotification(t('greatPerformanceNoWeaknesses'), 'success');
                setIsGeneratingWeaknessSummary(false);
                return;
            }
            let prompt = `قم بتحليل الأسئلة التالية التي أجاب عليها المستخدم بشكل غير صحيح. لخص باللغة العربية أهم 2-3 نقاط ضعف أو أنواع أخطاء متكررة يظهرها المستخدم.`;
            prompt += `\n\nالأسئلة الخاطئة:\n`;
            incorrectQs.forEach((q, i) => { prompt += `السؤال ${i + 1}: ${q.question} (الإجابة الصحيحة: ${q.correctAnswer}, إجابة المستخدم: ${userAnswers[selectedQuestions.indexOf(q)]})\n`; });
            try {
                const summaryText = await callGeminiAPI(prompt);
                setWeaknessSummary(summaryText);
            } catch (err) { setError(t('errorSummarizingWeaknesses') + ` ${err.message}`); }
            finally { setIsGeneratingWeaknessSummary(false); }
          }, [selectedQuestions, userAnswers, t, callGeminiAPI, showNotification]);

          const generateFactOfTheDayFromLLM = useCallback(async () => {
            if (!llmTopic.trim() && sourceType !== 'llm') return; 
            setIsGeneratingFact(true); setFactOfTheDay('');
            let topicForFact = llmTopic.trim();
            if (!topicForFact && selectedQuestions.length > 0) { 
                topicForFact = selectedQuestions[0].question.split(" ").slice(0, 5).join(" "); 
            }
            if (!topicForFact) { setIsGeneratingFact(false); return; }

            const prompt = `قدم حقيقة واحدة مثيرة للاهتمام وموجزة باللغة العربية حول موضوع "${topicForFact}".`;
            try {
                const factText = await callGeminiAPI(prompt);
                setFactOfTheDay(factText);
            } catch (err) {
                console.error("Error generating fact of the day:", err);
            } finally {
                setIsGeneratingFact(false);
            }
          }, [llmTopic, sourceType, selectedQuestions, callGeminiAPI]);

          const generateChallengeQuestionFromLLM = useCallback(async () => {
            setIsGeneratingChallengeQuestion(true); 
            setChallengeQuestion(null); 
            setChallengeQuestionFeedback(null);
            setChallengeQuestionAnswer('');
            setError('');

            let topicForChallenge = llmTopic.trim();
            if (!topicForChallenge && selectedQuestions.length > 0) {
                 topicForChallenge = selectedQuestions[0].question.split(" ").slice(0, 5).join(" ");
            }
             if (!topicForChallenge) { 
                 setError(t('errorNoTopicForChallenge')); 
                 setIsGeneratingChallengeQuestion(false);
                 return;
            }

            const prompt = `Generate one significantly harder multiple-choice quiz question in Arabic about "${topicForChallenge}". The question should have 4 options, and one of them MUST be the correct answer. Provide the output as a single JSON object with "question" (string), "options" (array of strings), and "correctAnswer" (string).`;
            const schema = {
                type: "OBJECT", properties: {
                    "question": { "type": "STRING" },
                    "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                    "correctAnswer": { "type": "STRING" }
                }, required: ["question", "options", "correctAnswer"]
            };
            try {
                const jsonString = await callGeminiAPI(prompt, { responseMimeType: "application/json", responseSchema: schema });
                const cq = JSON.parse(jsonString);
                if (cq.question && Array.isArray(cq.options) && cq.options.length === 4 && cq.correctAnswer && cq.options.includes(cq.correctAnswer)) {
                    setChallengeQuestion(cq);
                    setShowChallengeQuestionModal(true);
                } else {
                    throw new Error("Invalid challenge question format from AI.");
                }
            } catch (err) {
                setError(t('errorGeneratingChallengeQuestion') + ` ${err.message}`); 
                console.error("Error generating challenge question:", err);
            } finally {
                setIsGeneratingChallengeQuestion(false);
            }
          }, [llmTopic, selectedQuestions, t, callGeminiAPI]);

          const handleChallengeAnswer = useCallback((answer) => {
            if (!challengeQuestion) return;
            const isCorrect = answer === challengeQuestion.correctAnswer;
            setChallengeQuestionFeedback({ correct: isCorrect, correctAnswer: challengeQuestion.correctAnswer });
            if(soundEffects) playSound(isCorrect 
                ? { frequency: "G5", duration: "8n", type: "triangle", volume: -8 } 
                : { frequency: "A2", duration: "4n", type: "square", volume: -12 }
            );
          }, [challengeQuestion, soundEffects, playSound]);


          const generateQuizAnalysis = useCallback(async () => {
            setIsAnalyzingQuiz(true); setQuizAnalysis(''); setError('');
            let prompt = `حلل أداء المستخدم في الاختبار التالي. قدم رؤى حول نقاط القوة والضعف لديهم. اقترح أيضًا مجالات لمزيد من الدراسة.`;
            prompt += `\n\nنتائج الاختبار:\n`;
            prompt += `إجمالي الأسئلة: ${selectedQuestions.length}\n`;
            prompt += `الإجابات الصحيحة: ${score}\n`;
            prompt += `الإجابات الخاطئة: ${selectedQuestions.length - score}\n\n`;
            prompt += `تفاصيل كل سؤال:\n`;
            selectedQuestions.forEach((q, index) => {
                prompt += `\nالسؤال ${index + 1}: ${q.question}\nإجابتك: ${userAnswers[index] !== undefined ? userAnswers[index] : '(لم تتم الإجابة)'}\nالإجابة الصحيحة: ${q.correctAnswer}\nالحالة: ${userAnswers[index] === q.correctAnswer ? 'صحيحة' : 'خاطئة'}\n`;
            });
            prompt += `\n\nيرجى تقديم التحليل باللغة العربية.`;
            try {
                const analysisText = await callGeminiAPI(prompt);
                setQuizAnalysis(analysisText);
            } catch (err) { setError(t('errorAnalyzingPerformance') + ` ${err.message}`); }
            finally { setIsAnalyzingQuiz(false); }
          }, [selectedQuestions, score, userAnswers, t, callGeminiAPI]);

          const generateStudyMaterial = useCallback(async () => {
            if (!llmTopic.trim()) { setError(t('errorEnterTopicForStudyMaterial')); return; }
            setIsGeneratingStudyMaterial(true); setStudyMaterial(''); setError('');
            const prompt = `أنشئ ملخصًا دراسيًا موجزًا (حوالي 150-200 كلمة) حول الموضوع: "${llmTopic}". ركز على الحقائق الأساسية والمفاهيم الهامة. تأكد من أن الملخص باللغة العربية.`;
            try {
                const materialText = await callGeminiAPI(prompt);
                setStudyMaterial(materialText);
            } catch (err) { setError(t('errorGeneratingStudyMaterial') + ` ${err.message}`); }
            finally { setIsGeneratingStudyMaterial(false); }
          }, [llmTopic, t, callGeminiAPI]);
          
          const generateQuizChallenge = useCallback(async () => {
            if (!llmTopic.trim()) { setError(t('errorEnterTopicForChallenge')); return; }
            setIsGeneratingChallenge(true); setQuizChallenge(''); setError('');
            const prompt = `أنشئ تحديًا إبداعيًا للاختبار أو سيناريو لحل المشكلات يتعلق بالموضوع: "${llmTopic}". يجب أن يشجع هذا على التفكير النقدي أو تطبيق المعرفة، وليس مجرد التذكر. اجعله موجزًا، حوالي 100-150 كلمة. تأكد من أن التحدي باللغة العربية.`;
            try {
                const challengeText = await callGeminiAPI(prompt);
                setQuizChallenge(challengeText);
            } catch (err) { setError(t('errorGeneratingQuizChallenge') + ` ${err.message}`); }
            finally { setIsGeneratingChallenge(false); }
          }, [llmTopic, t, callGeminiAPI]);

          const generateRelatedTopicsFromLLM = useCallback(async () => {
            if (!llmTopic.trim()) { setError(t('errorEnterTopicForRelated')); return; }
            setIsGeneratingRelatedTopics(true); setRelatedTopics([]); setError('');
            const prompt = `أنشئ قائمة من 5-7 مواضيع أو كلمات رئيسية ذات صلة بالموضوع: "${llmTopic}". قدم الناتج كـ JSON array of strings. تأكد من أن المواضيع باللغة العربية.`;
            const schema = { type: "ARRAY", items: { "type": "STRING" } };
            try {
                const jsonString = await callGeminiAPI(prompt, { responseMimeType: "application/json", responseSchema: schema });
                const parsedTopics = JSON.parse(jsonString);
                if (Array.isArray(parsedTopics) && parsedTopics.every(item => typeof item === 'string')) {
                    setRelatedTopics(parsedTopics);
                } else { throw new Error(t('errorInvalidTopicsGenerated')); }
            } catch (err) { setError(t('errorGeneratingRelatedTopics') + ` ${err.message}`); }
            finally { setIsGeneratingRelatedTopics(false); }
          }, [llmTopic, t, callGeminiAPI]);
          
          const generateReviewQuestionsFromLLM = useCallback(async () => {
            const incorrectQs = selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer);
            if (incorrectQs.length === 0) { showNotification(t('errorNoIncorrectToReview'), 'info'); return; }
            setIsGeneratingReviewQuestions(true); setReviewQuestions([]); setError('');
            let prompt = `أنشئ 3-5 أسئلة اختبار متعددة الخيارات للمراجعة بناءً على الأسئلة التالية التي تمت الإجابة عليها بشكل غير صحيح. يجب أن يحتوي كل سؤال جديد على 4 خيارات وإجابة صحيحة. ركز على المفاهيم من الأسئلة الأصلية غير الصحيحة. قدم الناتج كـ JSON array of objects، حيث يحتوي كل كائن على "question" (string)، "options" (array of strings)، و "correctAnswer" (string، والذي يجب أن يكون أحد الخيارات). تأكد من أن الأسئلة باللغة العربية.\n\nالأسئلة التي تمت الإجابة عليها بشكل غير صحيح:\n`;
            incorrectQs.forEach((q, i) => { prompt += `\nالسؤال ${i + 1}: ${q.question}\nالإجابة الصحيحة: ${q.correctAnswer}\n`; });
            const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { "question": { "type": "STRING" }, "options": { "type": "ARRAY", "items": { "type": "STRING" } }, "correctAnswer": { "type": "STRING" } }, required: ["question", "options", "correctAnswer"] } };
            try {
                const jsonString = await callGeminiAPI(prompt, { responseMimeType: "application/json", responseSchema: schema });
                const genReviewQs = JSON.parse(jsonString);
                validateQuestions(genReviewQs);
                setReviewQuestions(genReviewQs);
                showNotification(t('reviewQuestionsGeneratedSuccess'), 'success');
            } catch (err) { setError(t('errorGeneratingReviewQuestions') + ` ${err.message}`); }
            finally { setIsGeneratingReviewQuestions(false); }
          }, [selectedQuestions, userAnswers, t, callGeminiAPI, validateQuestions, showNotification]);

          const extractKeyConceptsFromLLM = useCallback(async () => {
            if (selectedQuestions.length === 0) { showNotification(t('errorNoQuestionsToExtractConcepts'), 'info'); return; }
            setIsExtractingConcepts(true); setKeyConcepts(''); setError('');
            let prompt = `استخلص المفاهيم الأساسية والمواضيع الرئيسية من أسئلة الاختبار التالية. قدم ملخصًا موجزًا لهذه المفاهيم.\n\nأسئلة الاختبار:\n`;
            selectedQuestions.forEach((q, i) => { prompt += `\nالسؤال ${i + 1}: ${q.question}\n`; });
            prompt += `\n\nيرجى تقديم المفاهيم الأساسية باللغة العربية.`;
            try {
                const conceptsText = await callGeminiAPI(prompt);
                setKeyConcepts(conceptsText);
            } catch (err) { setError(t('errorExtractingConcepts') + ` ${err.message}`); }
            finally { setIsExtractingConcepts(false); }
          }, [selectedQuestions, t, callGeminiAPI, showNotification]);

          const generateOpenEndedQuestionsFromLLM = useCallback(async () => {
            if (!llmTopic.trim()) { setError(t('errorEnterTopicForOpenEnded')); return; }
            setIsGeneratingOpenEndedQuestions(true); setOpenEndedQuestions(''); setError('');
            const prompt = `أنشئ 3-5 أسئلة مفتوحة حول الموضوع: "${llmTopic}". يجب أن تشجع هذه الأسئلة على التفكير النقدي والإجابات التفصيلية. تأكد من أن الأسئلة باللغة العربية.`;
            try {
                const openQsText = await callGeminiAPI(prompt);
                setOpenEndedQuestions(openQsText);
            } catch (err) { setError(t('errorGeneratingOpenEnded') + ` ${err.message}`); }
            finally { setIsGeneratingOpenEndedQuestions(false); }
          }, [llmTopic, t, callGeminiAPI]);
          
          const generateFollowUpQuestionFromLLM = useCallback(async () => {
            if (!activeCurrentQuestion) { setError(t('errorNoActiveQuestionForFollowUp')); return; }
            setIsGeneratingFollowUpQuestion(true); setFollowUpQuestion(''); setError('');
            const { question, correctAnswer } = activeCurrentQuestion;
            let prompt = `بناءً على سؤال الاختبار التالي وإجابته الصحيحة، أنشئ سؤال متابعة واحدًا وموجزًا يشجع على التفكير الأعمق أو يستكشف جانبًا ذا صلة.\n\nالسؤال الأصلي: "${question}"\nالإجابة الصحيحة: "${correctAnswer}"\n`;
            if (explanation) prompt += `الشرح المقدم: "${explanation}"\n`;
            prompt += `تأكد من أن سؤال المتابعة باللغة العربية.`;
            try {
                const followupText = await callGeminiAPI(prompt);
                setFollowUpQuestion(followupText);
            } catch (err) { setError(t('errorGeneratingFollowUp') + ` ${err.message}`); }
            finally { setIsGeneratingFollowUpQuestion(false); }
          }, [activeCurrentQuestion, explanation, t, callGeminiAPI]);

          const generatePersonalizedStudyTipsFromLLM = useCallback(async () => {
            setIsGeneratingStudyTips(true); setPersonalizedStudyTips(''); setError('');
            let prompt = `بناءً على أداء الاختبار التالي، قدم نصائح دراسية مخصصة لمساعدة المستخدم على التحسن. ركز على المجالات التي ارتكب فيها أخطاء واقترح استراتيجيات تعلم فعالة.\n\nملخص أداء الاختبار:\nإجمالي الأسئلة: ${selectedQuestions.length}\nالإجابات الصحيحة: ${score}\nالإجابات الخاطئة: ${selectedQuestions.length - score}\n`;
            if (selectedQuestions.length - score > 0) {
                prompt += `\nالأسئلة التي تمت الإجابة عليها بشكل غير صحيح:\n`;
                selectedQuestions.forEach((q, index) => { if (userAnswers[index] !== q.correctAnswer) prompt += `- السؤال: "${q.question}" (الصحيحة: "${q.correctAnswer}", إجابتك: "${userAnswers[index]}")\n`; });
            } else { prompt += `\nتمت الإجابة على جميع الأسئلة بشكل صحيح! اقترح تقنيات دراسة متقدمة.`; }
            if (llmTopic.trim()) prompt += `\nموضوع الاختبار كان: "${llmTopic}".`;
            prompt += `\n\nيرجى تقديم النصائح الدراسية المخصصة باللغة العربية.`;
            try {
                const tipsText = await callGeminiAPI(prompt);
                setPersonalizedStudyTips(tipsText);
            } catch (err) { setError(t('errorGeneratingPersonalizedStudyTips') + ` ${err.message}`); }
            finally { setIsGeneratingStudyTips(false); }
          }, [selectedQuestions, score, userAnswers, llmTopic, t, callGeminiAPI]);

          // --- Quiz Flow Functions ---
          const startQuiz = useCallback(async () => { 
             if (!questions || questions.length === 0) { setError(t('errorNoQuestionsAvailable')); return; }
             const numToStart = Number.isInteger(numQuestions) && numQuestions > 0 ? numQuestions : defaultQuizLength; 
             if (numToStart > questions.length) { setError(t('errorNumberTooLarge', {val1: numToStart, val2: questions.length})); setNumQuestions(questions.length); return; }
             setError(''); clearAllLLMOutputs();
             const shuffled = shuffleArray(questions).slice(0, numToStart);
             setSelectedQuestions(shuffled);
             setUserAnswers({}); setCurrentIndex(0); setScore(0); setShowResult(false);
             setFeedback(null); setIsNextVisible(false); setShowCancelConfirm(false);
             setQuizStarted(true);

             if (llmTopic.trim() || sourceType === 'llm') {
                await generateFactOfTheDayFromLLM();
             }
          }, [questions, numQuestions, defaultQuizLength, t, clearAllLLMOutputs, generateFactOfTheDayFromLLM, llmTopic, sourceType]);

          const handleAnswer = useCallback((answer) => {
             if (!activeCurrentQuestion || feedback) return;
             const isCorrect = answer === activeCurrentQuestion.correctAnswer;
             if (isCorrect) {
                setScore(prevScore => prevScore + 1);
                if(soundEffects) playSound({ frequency: "C5", duration: "8n", type: "sine", envelope: { attack: 0.001, decay: 0.1, sustain: 0.05, release: 0.2 }, volume: -10 });
             } else {
                if(soundEffects) playSound({ frequency: "C3", duration: "4n", type: "sawtooth", envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }, volume: -15 });
             }
             setUserAnswers(prev => ({ ...prev, [currentIndex]: answer }));
             setFeedback({ correct: isCorrect, correctAnswer: activeCurrentQuestion.correctAnswer, userAnswer: answer });
             setIsNextVisible(true);
             setHint(''); 
             setEli5Explanation(''); setRealWorldApplications(''); setAnalogy(''); setFlashcard('');
          }, [activeCurrentQuestion, feedback, currentIndex, soundEffects, playSound]);

          const goToNextQuestion = useCallback(() => {
            const nextIndex = currentIndex + 1;
            if (nextIndex < selectedQuestions.length) {
                setCurrentIndex(nextIndex); setFeedback(null); setIsNextVisible(false);
                clearAllLLMOutputs(); 
            } else { setShowResult(true); }
          }, [currentIndex, selectedQuestions.length, clearAllLLMOutputs]);

          const resetQuiz = useCallback(() => {
             setQuizStarted(false); setSelectedQuestions([]); setUserAnswers({}); setCurrentIndex(0); setScore(0);
             setShowResult(false); setFeedback(null); setIsNextVisible(false);
             setError(''); setNotification({ message: '', type: '' }); setShowCancelConfirm(false);
             setLlmTopic(''); clearAllLLMOutputs(); setDifficulty('medium'); 
             setNumQuestions(defaultQuizLength); 
          }, [defaultQuizLength, clearAllLLMOutputs]);

          const handleCancelRequest = useCallback(() => setShowCancelConfirm(true), []);
          const confirmCancel = useCallback(() => resetQuiz(), [resetQuiz]);
          const abortCancel = useCallback(() => setShowCancelConfirm(false), []);

          // Combined loading state for any LLM operation
          const anyLLMLoading = isGeneratingQuestions || isExplaining || isAnalyzingQuiz || isGeneratingStudyMaterial ||
                                isGeneratingChallenge || isGeneratingRelatedTopics || isGeneratingReviewQuestions ||
                                isExtractingConcepts || isGeneratingOpenEndedQuestions || isGeneratingFollowUpQuestion ||
                                isGeneratingStudyTips || isGeneratingHint || isGeneratingEli5 || isGeneratingApplications ||
                                isGeneratingMisconceptions || isGeneratingAnalogy || isGeneratingFlashcard || 
                                isGeneratingStudyPlan || isGeneratingWeaknessSummary || isGeneratingFact || isGeneratingChallengeQuestion || isSavingProfile;

          const toggleTheme = useCallback(() => {
            const newTheme = theme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            saveSettingsToFirestore({ 
                theme: newTheme, defaultAiQuestions, defaultQuizLength, soundEffects, appLanguage 
            });
          }, [theme, defaultAiQuestions, defaultQuizLength, soundEffects, appLanguage, saveSettingsToFirestore]);
          
          const handleDefaultAiQuestionsChange = useCallback((value) => {
            const newCount = parseInt(value) || 1;
            setDefaultAiQuestions(newCount);
            saveSettingsToFirestore({ theme, defaultAiQuestions: newCount, defaultQuizLength, soundEffects, appLanguage });
          }, [theme, defaultQuizLength, soundEffects, appLanguage, saveSettingsToFirestore]);

          const handleDefaultQuizLengthChange = useCallback((value) => {
            const newLength = parseInt(value) || 1;
            setDefaultQuizLength(newLength);
            if (!quizStarted) setNumQuestions(newLength); 
            saveSettingsToFirestore({ theme, defaultAiQuestions, defaultQuizLength: newLength, soundEffects, appLanguage });
          }, [theme, defaultAiQuestions, soundEffects, appLanguage, quizStarted, saveSettingsToFirestore]);
        
          const handleToggleSoundEffects = useCallback(() => {
            const newSoundEffects = !soundEffects;
            setSoundEffects(newSoundEffects);
            saveSettingsToFirestore({ theme, defaultAiQuestions, defaultQuizLength, soundEffects: newSoundEffects, appLanguage });
          }, [theme, defaultAiQuestions, defaultQuizLength, soundEffects, appLanguage, saveSettingsToFirestore]);

          const handleAppLanguageChange = useCallback((value) => {
            setAppLanguage(value);
            saveSettingsToFirestore({ theme, defaultAiQuestions, defaultQuizLength, soundEffects, appLanguage: value });
          }, [theme, defaultAiQuestions, defaultQuizLength, soundEffects, saveSettingsToFirestore]);


          const handleResetSettings = useCallback(() => {
            const defaultSettings = {
                theme: 'light',
                defaultAiQuestions: 5,
                defaultQuizLength: 5,
                soundEffects: true,
                appLanguage: 'ar'
            };
            setTheme(defaultSettings.theme);
            setDefaultAiQuestions(defaultSettings.defaultAiQuestions);
            setDefaultQuizLength(defaultSettings.defaultQuizLength);
            setSoundEffects(defaultSettings.soundEffects);
            setAppLanguage(defaultSettings.appLanguage);
            if (!quizStarted) setNumQuestions(defaultSettings.defaultQuizLength);
            saveSettingsToFirestore(defaultSettings);
            showNotification(t('settingsResetNotification'), "info");
          }, [t, showNotification, saveSettingsToFirestore, quizStarted]);


          // --- Render Components ---
          const SettingsPanel = React.memo(({ 
                currentTheme, onToggleTheme, onClose, 
                currentDefaultAiQuestions, onSetDefaultAiQuestions,
                currentDefaultQuizLength, onSetDefaultQuizLength,
                currentSoundEffects, onToggleSoundEffects,
                currentAppLanguage, onSetAppLanguage,
                onResetAllSettings,
                t 
            }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300 ease-in-out" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 ease-in-out scale-95 opacity-0 animate-fadeInUp" onClick={(e) => e.stopPropagation()} style={{animationName: 'fadeInUpSlight', animationDuration: '0.3s', animationFillMode: 'forwards'}}>
                        <div className="flex justify-between items-center mb-6 pb-3 border-b border-gray-200 dark:border-gray-700">
                            <h2 className="text-2xl font-semibold text-gray-800 dark:text-gray-100">{t('settings')}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors p-1 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <div className="space-y-6">
                            <div className="flex justify-between items-center py-2">
                                <span className="text-gray-700 dark:text-gray-300 text-lg">{t('darkMode')}</span>
                                <button 
                                    onClick={onToggleTheme} 
                                    className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:focus:ring-offset-gray-800 ${currentTheme === 'dark' ? 'bg-purple-600' : 'bg-gray-300 dark:bg-gray-600'}`}
                                >
                                    <span className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out ${currentTheme === 'dark' ? 'translate-x-6' : 'translate-x-1'}`}/>
                                </button>
                            </div>

                            <div className="py-2">
                                <label htmlFor="default-ai-questions" className="block text-lg text-gray-700 dark:text-gray-300 mb-1">{t('defaultAIGeneratedQuestions')}</label>
                                <input 
                                    type="number" 
                                    id="default-ai-questions"
                                    value={currentDefaultAiQuestions}
                                    onChange={(e) => onSetDefaultAiQuestions(parseInt(e.target.value) || 1)}
                                    min="1"
                                    max="20"
                                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200 focus:ring-purple-500 focus:border-purple-500 force-ltr"
                                />
                            </div>

                            <div className="py-2">
                                <label htmlFor="default-quiz-length" className="block text-lg text-gray-700 dark:text-gray-300 mb-1">{t('defaultQuizLength')}</label>
                                <input 
                                    type="number" 
                                    id="default-quiz-length"
                                    value={currentDefaultQuizLength}
                                    onChange={(e) => onSetDefaultQuizLength(parseInt(e.target.value) || 1)}
                                    min="1"
                                    max="50" 
                                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200 focus:ring-purple-500 focus:border-purple-500 force-ltr"
                                />
                            </div>

                            <div className="flex justify-between items-center py-2">
                                <span className="text-gray-700 dark:text-gray-300 text-lg">{t('soundEffects')}</span>
                                <button 
                                    onClick={onToggleSoundEffects} 
                                    className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:focus:ring-offset-gray-800 ${currentSoundEffects ? 'bg-purple-600' : 'bg-gray-300 dark:bg-gray-600'}`}
                                >
                                    <span className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ease-in-out ${currentSoundEffects ? 'translate-x-6' : 'translate-x-1'}`}/>
                                </button>
                            </div>

                             <div className="py-2">
                                <label htmlFor="app-language" className="block text-lg text-gray-700 dark:text-gray-300 mb-1">{t('appLanguage')}</label>
                                <select 
                                    id="app-language" 
                                    value={currentAppLanguage} 
                                    onChange={(e) => onSetAppLanguage(e.target.value)}
                                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200 focus:ring-purple-500 focus:border-purple-500"
                                >
                                    <option value="ar">{t('arabic')}</option>
                                    <option value="en">{t('english')}</option> 
                                </select>
                            </div>
                        </div>
                         <div className="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-3">
                            <button onClick={onResetAllSettings} className="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm hover:shadow-md text-sm">
                                {t('resetAllSettings')}
                            </button>
                            <button onClick={onClose} className="w-full sm:w-auto bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-6 rounded-lg transition-colors shadow-sm hover:shadow-md">
                                {t('close')}
                            </button>
                        </div>
                    </div>
                </div>
            );
          });

          const UserProfilePanel = React.memo(({
            currentUserProfile, onSaveProfile, onClose, anyLLMLoading, isSaving, t
          }) => {
            const [displayName, setDisplayName] = useState(currentUserProfile.displayName || '');
            const [photoURL, setPhotoURL] = useState(currentUserProfile.photoURL || '');

            const handleSave = () => {
                onSaveProfile({ displayName, photoURL });
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300 ease-in-out" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 ease-in-out scale-95 opacity-0 animate-fadeInUp" onClick={(e) => e.stopPropagation()} style={{animationName: 'fadeInUpSlight', animationDuration: '0.3s', animationFillMode: 'forwards'}}>
                        <div className="flex justify-between items-center mb-6 pb-3 border-b border-gray-200 dark:border-gray-700">
                            <h2 className="text-2xl font-semibold text-gray-800 dark:text-gray-100">{t('userProfilePanelTitle')}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors p-1 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label htmlFor="displayName" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('displayNameLabel')}</label>
                                <input 
                                    type="text" 
                                    id="displayName" 
                                    value={displayName} 
                                    onChange={(e) => setDisplayName(e.target.value)}
                                    placeholder={t('displayNamePlaceholder')}
                                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500"
                                    disabled={isSaving}
                                />
                            </div>
                            <div>
                                <label htmlFor="photoURL" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('photoURLLabel')}</label>
                                <input 
                                    type="url" 
                                    id="photoURL"
                                    value={photoURL}
                                    onChange={(e) => setPhotoURL(e.target.value)}
                                    placeholder={t('photoURLPlaceholder')}
                                    className="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-gray-200 focus:ring-indigo-500 focus:border-indigo-500 force-ltr"
                                    disabled={isSaving}
                                />
                            </div>
                        </div>
                        <div className="mt-8 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                             <button onClick={onClose} type="button" className="bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-200 font-medium py-2 px-4 rounded-lg transition-colors shadow-sm">
                                {t('close')}
                            </button>
                            <button 
                                onClick={handleSave} 
                                disabled={anyLLMLoading || isSaving}
                                className={`font-medium py-2 px-6 rounded-lg transition-colors shadow-sm hover:shadow-md flex items-center justify-center gap-2 ${anyLLMLoading || isSaving ? 'bg-gray-400 dark:bg-gray-500 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}
                            >
                                {isSaving ? <><span className="loading-spinner mr-2"></span> {t('savingButton')} </> : t('saveProfileButton')}
                            </button>
                        </div>
                    </div>
                </div>
            );
          });


          const ImportQuestionsForm = React.memo(({
            llmTopic, setLlmTopic, generateQuestionsFromLLM, anyLLMLoading, isGeneratingQuestions,
            difficulty, setDifficulty, generateStudyMaterial, isGeneratingStudyMaterial,
            generateQuizChallenge, isGeneratingChallenge, generateRelatedTopicsFromLLM, isGeneratingRelatedTopics,
            generateOpenEndedQuestionsFromLLM, isGeneratingOpenEndedQuestions, generateCommonMisconceptionsFromLLM, isGeneratingMisconceptions,
            studyMaterial, quizChallenge, relatedTopics, openEndedQuestions, commonMisconceptions,
            apiUrl, setApiUrl, fetchQuestionsFromApi, isLoading, sourceType,
            handleFileUpload, useDefaultQuestions, showFormatInfo, setShowFormatInfo,
            uploadedFileHistory, loadFromHistory, t
          }) => (
            <div className="bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-6">
              <h2 className="text-xl sm:text-2xl font-bold mb-4 text-center text-indigo-700 dark:text-indigo-400">{t('importOrGenerateQuestions')}</h2>
              {/* AI Question Generation Section */}
              <div className="mb-6 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg shadow-inner">
                <h3 className="text-lg font-semibold mb-3 text-purple-700 dark:text-purple-300">{t('generateWithAI')}</h3>
                <div className="flex flex-col sm:flex-row gap-2 mb-3">
                  <input type="text" value={llmTopic} onChange={(e) => setLlmTopic(e.target.value)} placeholder={t('enterTopicPlaceholder')} className={`flex-grow border-2 border-purple-300 dark:border-purple-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors ${anyLLMLoading ? 'bg-gray-100 dark:bg-gray-700 cursor-not-allowed' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100'}`} aria-label="LLM Topic Input" disabled={anyLLMLoading} dir={appLanguage === 'ar' ? 'rtl' : 'ltr'} style={{textAlign: appLanguage === 'ar' ? 'right' : 'left'}} />
                  <button onClick={generateQuestionsFromLLM} disabled={anyLLMLoading || !llmTopic.trim()} className={`font-medium py-2 px-4 rounded-lg transition-all duration-200 ease-in-out whitespace-nowrap flex items-center justify-center gap-2 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                    {isGeneratingQuestions ? <><span className="loading-spinner mr-2"></span><span>{t('generatingButton')}</span></> : t('generateQuestionsButton')}
                  </button>
                </div>
                <div className="mb-3">
                    <label htmlFor="difficulty-select" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{t('difficultyLevel')}</label>
                    <select id="difficulty-select" value={difficulty} onChange={(e) => setDifficulty(e.target.value)} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full p-2 border-2 border-purple-300 dark:border-purple-600 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500 transition-colors ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-100 dark:bg-gray-700 cursor-not-allowed' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100'}`}>
                        <option value="easy">{t('easy')}</option>
                        <option value="medium">{t('medium')}</option>
                        <option value="hard">{t('hard')}</option>
                    </select>
                </div>

                {llmTopic.trim() && (
                    <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <button onClick={generateStudyMaterial} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-pink-500 hover:bg-pink-600 text-white shadow hover:shadow-md transform hover:-translate-y-px'}`}>
                            {isGeneratingStudyMaterial ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingStudyMaterialButton')}</span></> : t('generateStudyMaterialButton')}
                        </button>
                        <button onClick={generateQuizChallenge} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 text-white shadow hover:shadow-md transform hover:-translate-y-px'}`}>
                           {isGeneratingChallenge ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingQuizChallengeButton')}</span></> : t('generateQuizChallengeButton')}
                        </button>
                        <button onClick={generateRelatedTopicsFromLLM} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-blue-700 hover:bg-blue-800 text-white shadow hover:shadow-md transform hover:-translate-y-px'}`}>
                            {isGeneratingRelatedTopics ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingRelatedTopicsButton')}</span></> : t('generateRelatedTopicsButton')}
                        </button>
                        <button onClick={generateOpenEndedQuestionsFromLLM} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-fuchsia-500 hover:bg-fuchsia-600 text-white shadow hover:shadow-md transform hover:-translate-y-px'}`}>
                            {isGeneratingOpenEndedQuestions ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingOpenEndedQuestionsButton')}</span></> : t('generateOpenEndedQuestionsButton')}
                        </button>
                        <button onClick={generateCommonMisconceptionsFromLLM} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 lg:col-span-1 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600 text-white shadow hover:shadow-md transform hover:-translate-y-px'}`}>
                            {isGeneratingMisconceptions ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingMisconceptionsButton')}</span></> : t('revealCommonMisconceptionsButton')}
                        </button>
                    </div>
                )}
                {studyMaterial && (<div className="p-3 mt-4 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-2">{t('studyMaterialTitle')}</h4><p className="whitespace-pre-wrap">{studyMaterial}</p></div>)}
                {quizChallenge && (<div className="p-3 mt-4 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-2">{t('quizChallengeTitle')}</h4><p className="whitespace-pre-wrap">{quizChallenge}</p></div>)}
                {relatedTopics.length > 0 && (<div className="p-3 mt-4 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-2">{t('relatedTopicsTitle')}</h4><div className="flex flex-wrap gap-2">{relatedTopics.map((topic, index) => (<span key={index} onClick={() => { setLlmTopic(topic); setRelatedTopics([]); setCommonMisconceptions(''); }} className="cursor-pointer bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 px-3 py-1 rounded-full text-xs transition-colors shadow-sm text-gray-700 dark:text-gray-200">{topic}</span>))}</div></div>)}
                {openEndedQuestions && (<div className="p-3 mt-4 bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-2">{t('openEndedQuestionsTitle')}</h4><p className="whitespace-pre-wrap">{openEndedQuestions}</p></div>)}
                {commonMisconceptions && (<div className="p-3 mt-4 bg-orange-50 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-2">{t('commonMisconceptionsTitle')}</h4><p className="text-orange-600 dark:text-orange-200 whitespace-pre-wrap">{commonMisconceptions}</p></div>)}
              </div>
              

              <div className="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg shadow-inner">
                <h3 className="text-lg font-semibold mb-3 text-blue-700 dark:text-blue-300">{t('importFromAPI')}</h3>
                <div className="flex flex-col sm:flex-row gap-2">
                  <input type="url" value={apiUrl} onChange={(e) => setApiUrl(e.target.value)} placeholder={t('apiURLExample')} className={`flex-grow border-2 border-blue-300 dark:border-blue-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors force-ltr ${anyLLMLoading || isLoading ? 'bg-gray-100 dark:bg-gray-700 cursor-not-allowed' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100'}`} aria-label="API URL Input" disabled={anyLLMLoading || isLoading} />
                  <button onClick={fetchQuestionsFromApi} disabled={anyLLMLoading || isLoading || !apiUrl.trim()} className={`font-medium py-2 px-4 rounded-lg transition-all duration-200 ease-in-out whitespace-nowrap flex items-center justify-center gap-2 ${anyLLMLoading || isLoading || !apiUrl.trim() ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                    {isLoading && sourceType === 'api' ? <><span className="loading-spinner mr-2"></span><span>{t('loadingButton')}</span></> : t('importButton')}
                  </button>
                </div>
              </div>

              <div className="mb-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg shadow-inner">
                   <h3 className="text-lg font-semibold mb-3 text-green-700 dark:text-green-300">{t('importFromFile')}</h3>
                   <div className="flex items-center justify-center w-full">
                   <label htmlFor="file-upload" className={`flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg ${anyLLMLoading || isLoading ? 'bg-gray-100 dark:bg-gray-700 cursor-wait' : 'cursor-pointer bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500 transition-colors'}`}>
                       <div className="flex flex-col items-center justify-center pt-5 pb-6">
                       <svg className="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                       <p className="mb-2 text-sm text-gray-500 dark:text-gray-400"><span className="font-semibold">{t('clickToUpload')}</span> {t('dragDropHere')}</p>
                       <p className="text-xs text-gray-500 dark:text-gray-400">{t('jsonOnly')}</p>
                       </div>
                       <input id="file-upload" type="file" className="hidden" accept=".json,application/json" onChange={handleFileUpload} disabled={anyLLMLoading || isLoading} aria-label="JSON File Upload"/>
                   </label>
                   </div>
              </div>

              <div className="text-center mb-6">
                   <button onClick={useDefaultQuestions} disabled={anyLLMLoading || isLoading} className={`font-medium py-2 px-6 rounded-lg transition-all duration-200 ease-in-out ${anyLLMLoading || isLoading ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-gray-500 hover:bg-gray-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>{t('useDefaultQuestionsButton')}</button>
              </div>

              {error && (<div className="mt-4 p-3 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-200 rounded-lg text-center break-words shadow" role="alert">{error}</div>)}
              {notification.message && (<div className={`mt-4 p-3 rounded-lg text-center shadow ${notification.type === 'success' ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-200' : notification.type === 'error' ? 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-200' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-200'}`} role="status">{notification.message}</div>)}

              <div className="mt-6 text-center">
                   <button onClick={() => setShowFormatInfo(!showFormatInfo)} className="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 underline text-sm transition-colors">{showFormatInfo ? t('hideJSONFormatInfo') : t('showJSONFormatInfo')}</button>
                   {showFormatInfo && (<div className="mt-2 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg shadow-inner"><h4 className="font-medium text-indigo-800 dark:text-indigo-200 mb-2">{t('requiredJSONFormat')}</h4><pre className="text-xs bg-gray-100 dark:bg-gray-700 dark:text-gray-300 p-2 rounded overflow-x-auto dir-ltr">{`[ { "question": "...", "options": ["...", "..."], "correctAnswer": "..." }, ... ]`}</pre></div>)}
              </div>

              {uploadedFileHistory.length > 0 && (
                   <div className="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                     <h3 className="text-lg font-medium mb-3 text-center text-gray-700 dark:text-gray-300">{t('recentlyUploaded')}</h3>
                     <ul className="space-y-2">
                       {uploadedFileHistory.map((item, index) => (
                         <li key={index} className="flex justify-between items-center bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                           <span className="text-gray-800 dark:text-gray-200 truncate pr-2" title={item.name}>{item.name}</span>
                           <button onClick={() => loadFromHistory(item.name)} className={`text-sm bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-1 px-3 rounded-md transition-all duration-200 ease-in-out whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed ${anyLLMLoading || isLoading ? '' : 'hover:shadow-md transform hover:-translate-y-0.5'}`} disabled={anyLLMLoading || isLoading}>{t('useButton')}</button>
                         </li>
                       ))}
                     </ul>
                   </div>
              )}
            </div>
          ));
          
          const MainContent = () => {
            if (!quizStarted) {
                const getSourceName = () => {
                     switch (sourceType) {
                       case 'default': return t('defaultSource'); case 'api': return t('apiSource');
                       case 'file': return t('fileSource'); case 'history': return t('historySource');
                       case 'llm': return t('llmSource'); case 'llm_review': return t('llmReviewSource');
                       default: return t('undefinedSource');
                     }
                };
                return (
                  <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-green-100 via-blue-100 to-purple-200 dark:from-green-900/30 dark:via-blue-900/30 dark:to-purple-900/30 p-4">
                    <div className="w-full" style={{maxWidth: '700px'}}>
                      <ImportQuestionsForm 
                        llmTopic={llmTopic} setLlmTopic={setLlmTopic} generateQuestionsFromLLM={generateQuestionsFromLLM} anyLLMLoading={anyLLMLoading} isGeneratingQuestions={isGeneratingQuestions}
                        difficulty={difficulty} setDifficulty={setDifficulty} generateStudyMaterial={generateStudyMaterial} isGeneratingStudyMaterial={isGeneratingStudyMaterial}
                        generateQuizChallenge={generateQuizChallenge} isGeneratingChallenge={isGeneratingChallenge} generateRelatedTopicsFromLLM={generateRelatedTopicsFromLLM} isGeneratingRelatedTopics={isGeneratingRelatedTopics}
                        generateOpenEndedQuestionsFromLLM={generateOpenEndedQuestionsFromLLM} isGeneratingOpenEndedQuestions={isGeneratingOpenEndedQuestions} generateCommonMisconceptionsFromLLM={generateCommonMisconceptionsFromLLM} isGeneratingMisconceptions={isGeneratingMisconceptions}
                        studyMaterial={studyMaterial} quizChallenge={quizChallenge} relatedTopics={relatedTopics} openEndedQuestions={openEndedQuestions} commonMisconceptions={commonMisconceptions}
                        apiUrl={apiUrl} setApiUrl={setApiUrl} fetchQuestionsFromApi={fetchQuestionsFromApi} isLoading={isLoading} sourceType={sourceType}
                        handleFileUpload={handleFileUpload} useDefaultQuestions={useDefaultQuestions} showFormatInfo={showFormatInfo} setShowFormatInfo={setShowFormatInfo}
                        uploadedFileHistory={uploadedFileHistory} loadFromHistory={loadFromHistory} t={t}
                      />
                      <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center">
                        <h2 className="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6">{t('startQuizTitle')}</h2>
                        <div className="flex flex-col items-center">
                          <p className="text-lg mb-2 text-gray-700 dark:text-gray-300">{t('questionSource')} <span className="font-semibold text-indigo-600 dark:text-indigo-400">{getSourceName()}</span></p>
                          <p className="text-lg mb-4 text-gray-700 dark:text-gray-300">{t('totalAvailableQuestions')} <span className="font-bold text-gray-800 dark:text-gray-100">{questions.length}</span></p>
                          {questions.length > 0 && (
                               <div className="mb-6">
                                 <label htmlFor="num-questions" className="block text-gray-700 dark:text-gray-300 mb-2 text-md">{t('chooseNumberOfQuestions')}</label>
                                 <input id="num-questions" type="number" className="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-2 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 w-32 text-center focus:outline-none focus:ring-2 focus:ring-yellow-500 dark:focus:ring-yellow-400 transition-colors shadow-sm force-ltr" value={numQuestions || ''} onChange={(e) => setNumQuestions(parseInt(e.target.value) || 0)} onBlur={(e) => { const val = parseInt(e.target.value); if (isNaN(val) || val < 1) setNumQuestions(defaultQuizLength > 0 ? Math.min(defaultQuizLength, questions.length) : 1); else if (val > questions.length) setNumQuestions(questions.length); else setNumQuestions(val); }} max={questions.length} min={1} aria-label="Number of questions to start" />
                               </div>
                          )}
                          <button className={`bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition-all duration-200 ease-in-out hover:scale-105 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed ${anyLLMLoading || isLoading ? 'animate-pulse' : ''}`} onClick={startQuiz} disabled={anyLLMLoading || isLoading || questions.length === 0 || !parseInt(numQuestions) || parseInt(numQuestions) <= 0 || parseInt(numQuestions) > questions.length}> {t('startQuizButton')} </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              }
    
              if (showResult) {
                const percentage = selectedQuestions.length > 0 ? (score / selectedQuestions.length) * 100 : 0;
                const resultMessageKey = percentage === 100 ? 'quizResultPerfect' : percentage >= 70 ? 'quizResultGreat' : percentage >= 50 ? 'quizResultGood' : 'quizResultKeepTrying';
                const message = t(resultMessageKey);
                const bgColor = percentage === 100 ? 'bg-green-100 dark:bg-green-800/30' : percentage >= 70 ? 'bg-teal-100 dark:bg-teal-800/30' : percentage >= 50 ? 'bg-blue-100 dark:bg-blue-800/30' : 'bg-yellow-100 dark:bg-yellow-800/30';
                const textColor = percentage === 100 ? 'text-green-800 dark:text-green-200' : percentage >= 70 ? 'text-teal-800 dark:text-teal-200' : percentage >= 50 ? 'text-blue-800 dark:text-blue-200' : 'text-yellow-800 dark:text-yellow-200';
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-800 p-4">
                        <div className={`p-6 sm:p-8 rounded-xl shadow-2xl ${bgColor} max-w-2xl mx-auto w-full ${textColor} transition-all duration-500 ease-out`} style={{ animation: 'fadeInUp 0.5s ease-out forwards' }}>
                            <h2 className="text-3xl sm:text-4xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">{t('quizEndedTitle')}</h2>
                            <div className="text-center mb-8 p-4 bg-white/50 dark:bg-gray-700/50 rounded-lg shadow">
                                <p className="text-xl sm:text-2xl font-semibold mb-2">{t('yourScore')} <span className="text-2xl sm:text-3xl font-bold">{score}</span> {t('from')} {selectedQuestions.length}</p>
                                <p className="text-xl sm:text-2xl font-semibold mb-4">{t('percentage')} <span className="text-2xl sm:text-3xl font-bold">{percentage.toFixed(1)}%</span></p>
                                <p className="text-md sm:text-lg mt-2 font-medium">{message}</p>
                            </div>
                            <div className="mt-8 pt-6 border-t border-gray-300/70 dark:border-gray-600">
                                <h3 className="text-xl sm:text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-4 text-center">{t('answerDetails')}</h3>
                                <ul className="list-none p-0 text-sm md:text-base space-y-3"> 
                                    {selectedQuestions.map((question, index) => {
                                        const userAnswer = userAnswers[index]; const isCorrect = userAnswer === question.correctAnswer;
                                        return (
                                            <li key={index} className={`p-4 rounded-lg shadow-md ${isCorrect ? 'bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30'} transition-colors duration-300 border-b border-gray-200 dark:border-gray-700 last:border-b-0`}>
                                                <p className="font-semibold text-gray-800 dark:text-gray-100 mb-2">{index + 1}. {question.question}</p>
                                                <p className="text-gray-700 dark:text-gray-300 mb-1"><span className="font-medium">{t('yourAnswer')} </span><span className={`user-answer-text ${isCorrect ? 'text-green-700 dark:text-green-300 font-semibold' : 'text-red-700 dark:text-red-300 font-semibold'}`}>{userAnswer !== undefined ? userAnswer : <span className="text-gray-500 dark:text-gray-400 italic">{t('notAnswered')}</span>}</span>{isCorrect ? <span className="correct-answer-indicator ms-2">✔️</span> : <span className="incorrect-answer-indicator ms-2">❌</span>}</p>
                                                {!isCorrect && (<p className="text-gray-700 dark:text-gray-300"><span className="font-medium">{t('correctAnswerLabel')} </span><span className="correct-answer-text font-semibold">{question.correctAnswer}</span></p>)}
                                            </li> );
                                    })}
                                </ul>
                            </div>
                            <div className="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <button onClick={generateQuizAnalysis} disabled={anyLLMLoading} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-teal-500 hover:bg-teal-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isAnalyzingQuiz ? <><span className="loading-spinner-dark mr-2"></span><span>{t('analyzingPerformanceButton')}</span></> : t('analyzePerformanceButton')}
                                </button>
                                <button onClick={generateQuizChallenge} disabled={anyLLMLoading || !llmTopic.trim()} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || !llmTopic.trim() ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-purple-500 hover:bg-purple-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isGeneratingChallenge ? <><span className="loading-spinner-dark mr-2"></span><span>{t('generatingQuizChallengeButton')}</span></> : t('generateQuizChallengeButton')}
                                </button>
                                <button onClick={generateReviewQuestionsFromLLM} disabled={anyLLMLoading || selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer).length === 0} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer).length === 0 ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isGeneratingReviewQuestions ? <><span className="loading-spinner-dark mr-2"></span><span>{t('generatingReviewQuestionsResultsButton')}</span></> : t('generateReviewQuestionsResultsButton')}
                                </button>
                                <button onClick={extractKeyConceptsFromLLM} disabled={anyLLMLoading || selectedQuestions.length === 0} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || selectedQuestions.length === 0 ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-800 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isExtractingConcepts ? <><span className="loading-spinner mr-2"></span><span>{t('extractingKeyConceptsButton')}</span></> : t('extractKeyConceptsButton')}
                                </button>
                                <button onClick={generatePersonalizedStudyTipsFromLLM} disabled={anyLLMLoading || selectedQuestions.length === 0} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || selectedQuestions.length === 0 ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-blue-800 hover:bg-blue-900 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isGeneratingStudyTips ? <><span className="loading-spinner mr-2"></span><span>{t('generatingStudyTipsButton')}</span></> : t('personalizedStudyTipsButton')}
                                </button>
                                 {(sourceType === 'llm' || llmTopic.trim()) && ( 
                                    <button onClick={generateCommonMisconceptionsFromLLM} disabled={anyLLMLoading || (!llmTopic.trim() && sourceType !== 'llm')} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || (!llmTopic.trim() && sourceType !== 'llm') ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-red-500 hover:bg-red-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                        {isGeneratingMisconceptions ? <><span className="loading-spinner-dark mr-2"></span><span> {t('generatingMisconceptionsResultsButton')}</span></> : t('showCommonMisconceptionsResultsButton')}
                                    </button>
                                )}
                                 <button onClick={generateStudyPlanFromLLM} disabled={anyLLMLoading || selectedQuestions.length === 0} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || selectedQuestions.length === 0 ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-emerald-500 hover:bg-emerald-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isGeneratingStudyPlan ? <><span className="loading-spinner-dark mr-2"></span><span>{t('creatingStudyPlanButton')}</span></> : t('createStudyPlanButton')}
                                </button>
                                <button onClick={summarizeWeaknessesFromLLM} disabled={anyLLMLoading || selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer).length === 0} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${anyLLMLoading || selectedQuestions.filter((q, index) => userAnswers[index] !== q.correctAnswer).length === 0 ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-rose-500 hover:bg-rose-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                    {isGeneratingWeaknessSummary ? <><span className="loading-spinner-dark mr-2"></span><span>{t('summarizingWeaknessesButton')}</span></> : t('summarizeWeaknessesButton')}
                                </button>
                                {percentage >= 70 && (sourceType === 'llm' || llmTopic.trim()) && (
                                    <button onClick={generateChallengeQuestionFromLLM} disabled={isGeneratingChallengeQuestion || anyLLMLoading} className={`w-full py-3 px-4 rounded-lg text-base font-semibold transition-all duration-200 ease-in-out flex items-center justify-center gap-2 ${isGeneratingChallengeQuestion || anyLLMLoading ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-yellow-500 hover:bg-yellow-600 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5'}`}>
                                        {isGeneratingChallengeQuestion ? <><span className="loading-spinner-dark mr-2"></span><span>{t('generatingChallengeQuestionButton')}</span></> : t('challengeMeButton')}
                                    </button>
                                )}
                            </div>
    
                            {quizAnalysis && (<div className="p-3 mt-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow"><h4 className="font-semibold mb-2 text-gray-700 dark:text-gray-200">{t('quizAnalysisTitle')}</h4><p className="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{quizAnalysis}</p></div>)}
                            {quizChallenge && (<div className="p-3 mt-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg shadow"><h4 className="font-semibold mb-2 text-indigo-700 dark:text-indigo-300">{t('quizChallengeTitle')}</h4><p className="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{quizChallenge}</p></div>)}
                            {commonMisconceptions && (<div className="p-3 mt-4 bg-orange-50 dark:bg-orange-900/30 rounded-lg shadow"><h4 className="font-semibold mb-2 text-orange-700 dark:text-orange-300">{t('commonMisconceptionsTitle')}</h4><p className="text-orange-600 dark:text-orange-200 whitespace-pre-wrap">{commonMisconceptions}</p></div>)}
                            {studyPlan && (<div className="p-3 mt-4 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg shadow"><h4 className="font-semibold mb-2 text-emerald-700 dark:text-emerald-300">{t('suggestedStudyPlanTitle')}</h4><p className="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{studyPlan}</p></div>)}
                            {weaknessSummary && (<div className="p-3 mt-4 bg-rose-50 dark:bg-rose-900/30 rounded-lg shadow"><h4 className="font-semibold mb-2 text-rose-700 dark:text-rose-300">{t('weaknessSummaryTitle')}</h4><p className="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{weaknessSummary}</p></div>)}
                            {reviewQuestions.length > 0 && (
                                <div className="p-3 mt-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg shadow">
                                    <h4 className="font-semibold mb-2 text-yellow-700 dark:text-yellow-300">{t('reviewQuestionsTitle')}</h4>
                                    <ul className="list-none p-0 space-y-3">
                                        {reviewQuestions.map((q, index) => (
                                            <li key={index} className="mb-3 pb-3 border-b border-yellow-200 dark:border-yellow-700 last:border-b-0 last:pb-0">
                                                <p className="font-semibold mb-1 text-gray-700 dark:text-gray-200">{index + 1}. {q.question}</p>
                                                <ul className="list-disc list-inside text-sm space-y-1 text-gray-600 dark:text-gray-300">
                                                    {q.options.map((opt, optIdx) => (<li key={optIdx} className={`${opt === q.correctAnswer ? 'font-medium text-green-700 dark:text-green-400' : ''}`}>{opt} {opt === q.correctAnswer && '✔️'}</li>))}
                                                </ul>
                                            </li>
                                        ))}
                                    </ul>
                                    <div className="mt-4 text-center"><button onClick={() => { setQuestions(reviewQuestions); setSourceType('llm_review'); setNumQuestions(reviewQuestions.length); startQuiz(); }} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 hover:shadow-lg">{t('startReviewQuizButton')}</button></div>
                                </div>
                            )}
                            {keyConcepts && (<div className="p-3 mt-4 bg-lime-50 dark:bg-lime-900/30 rounded-lg shadow"><h4 className="font-semibold mb-2 text-lime-700 dark:text-lime-300">{t('keyConceptsTitle')}</h4><p className="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{keyConcepts}</p></div>)}
                            {personalizedStudyTips && (<div className="p-3 mt-4 bg-sky-50 dark:bg-sky-900/30 rounded-lg shadow"><h4 className="font-semibold mb-2 text-sky-700 dark:text-sky-300">{t('personalizedStudyTipsTitle')}</h4><p className="text-gray-600 dark:text-gray-300 whitespace-pre-wrap">{personalizedStudyTips}</p></div>)}
                            <div className="mt-10 flex flex-col sm:flex-row gap-4 justify-center">
                                <button className="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 hover:shadow-xl" onClick={resetQuiz}> {t('newQuizButton')} </button>
                                <button className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 hover:shadow-xl" onClick={() => { clearAllLLMOutputs(); setUserAnswers({}); setCurrentIndex(0); setScore(0); setShowResult(false); setFeedback(null); setIsNextVisible(false); setShowCancelConfirm(false); }}> {t('retrySameQuizButton')} </button>
                            </div>
                        </div>
                    </div> );
              }
    
              if (quizStarted && !showResult) {
                if (!activeCurrentQuestion) {
                    return ( <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 p-4 font-sans"><div className="p-6 text-center bg-white dark:bg-gray-800 shadow-lg rounded-lg max-w-md mx-auto w-full"><h2 className="text-xl font-semibold mb-4 text-red-600 dark:text-red-400">{t('errorLoadingQuestion')}</h2><button className="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full" onClick={resetQuiz}>{t('backToStartButton')}</button></div></div> );
                }
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-purple-100 via-pink-100 to-red-100 dark:from-purple-900/30 dark:via-pink-900/30 dark:to-red-900/30 p-4">
                        <div className="p-6 sm:p-8 bg-white dark:bg-gray-800 shadow-2xl rounded-xl max-w-lg mx-auto w-full" style={{ animation: 'fadeIn 0.5s ease-out' }}>
                            {factOfTheDay && (
                                <div className="mb-4 p-3 bg-yellow-100 dark:bg-yellow-700/30 text-yellow-700 dark:text-yellow-200 rounded-lg text-sm shadow-inner text-center">
                                    <h4 className="font-semibold mb-1">{t('factOfTheDay')}</h4>
                                    <p>{isGeneratingFact ? t('generatingFact') : factOfTheDay}</p>
                                </div>
                            )}
                            <div className="flex justify-between items-center mb-6 text-sm sm:text-base">
                                <span className="bg-blue-100 dark:bg-blue-800/50 text-blue-800 dark:text-blue-200 font-medium px-4 py-2 rounded-full shadow-sm"> {t('questionLabel')} {currentIndex + 1} {t('from')} {selectedQuestions.length} </span>
                                <span className="bg-green-100 dark:bg-green-800/50 text-green-800 dark:text-green-200 font-medium px-4 py-2 rounded-full shadow-sm"> {t('scoreLabel')} {score} </span>
                            </div>
                            <h2 className={`text-xl md:text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-100 ${appLanguage === 'ar' ? 'text-right' : 'text-left'}`} dir={appLanguage === 'ar' ? 'rtl' : 'ltr'}> {activeCurrentQuestion.question} </h2>
                            
                            {!feedback && !hint && ( 
                                 <div className="mb-4 text-center">
                                    <button onClick={getHintFromLLM} disabled={isGeneratingHint || anyLLMLoading} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 mx-auto ${isGeneratingHint || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-yellow-400 hover:bg-yellow-500 text-yellow-900 shadow hover:shadow-md'}`}>
                                        {isGeneratingHint ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('requestingHintButton')}</span></> : t('requestHintButton')}
                                    </button>
                                </div>
                            )}
                            {hint && !feedback && ( 
                                <div className="p-3 mt-4 bg-yellow-50 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-1">{t('hintTitle')}</h4><p>{hint}</p></div>
                            )}
    
                            <div className={`grid grid-cols-1 gap-4 mb-6 ${appLanguage === 'ar' ? 'text-right' : 'text-left'}`} dir={appLanguage === 'ar' ? 'rtl' : 'ltr'}>
                                {currentOptions.map((option, idx) => {
                                    let buttonClass = 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white option-button';
                                    if (feedback) {
                                        if (option === activeCurrentQuestion.correctAnswer) buttonClass = 'bg-green-500 text-white ring-2 ring-green-700 dark:ring-green-500 ring-offset-2 dark:ring-offset-gray-800';
                                        else if (option === feedback.userAnswer) buttonClass = 'bg-red-500 text-white ring-2 ring-red-700 dark:ring-red-500 ring-offset-2 dark:ring-offset-gray-800 animate-shake';
                                        else buttonClass = 'bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-400 opacity-70 cursor-not-allowed';
                                    }
                                    return ( <button key={idx} className={`w-full py-3 px-5 rounded-lg font-medium shadow-md transition-all duration-300 ease-in-out transform hover:scale-102 disabled:opacity-70 disabled:cursor-not-allowed ${buttonClass}`} onClick={() => !feedback && handleAnswer(option)} disabled={!!feedback || anyLLMLoading} aria-pressed={!!feedback && option === feedback.userAnswer}> {option} </button> );
                                })}
                            </div>
    
                            {feedback && (
                                <div className={`mt-6 p-4 rounded-lg text-center font-semibold text-lg shadow-inner ${feedback.correct ? 'bg-green-100 dark:bg-green-800/30 text-green-700 dark:text-green-200' : 'bg-red-100 dark:bg-red-800/30 text-red-700 dark:text-red-200'}`}>
                                    {feedback.correct ? t('correctAnswerFeedback') : `${t('incorrectAnswerFeedback')} ${feedback.correctAnswer}`}
                                    <div className="mt-3 flex flex-col sm:flex-row justify-center items-center gap-2">
                                        <button onClick={getExplanationFromLLM} disabled={isExplaining || anyLLMLoading} className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${isExplaining || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-indigo-500 hover:bg-indigo-600 text-white shadow hover:shadow-md'}`}>
                                            {isExplaining ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('explainingAnswerButton')}</span></> : t('explainAnswerButton')}
                                        </button>
                                         <button onClick={generateFlashcardFromLLM} disabled={isGeneratingFlashcard || anyLLMLoading} className={`px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${isGeneratingFlashcard || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-lime-500 hover:bg-lime-600 text-white shadow hover:shadow-md'}`}>
                                            {isGeneratingFlashcard ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('creatingFlashcardButton')}</span></> : t('createFlashcardButton')}
                                        </button>
                                    </div>
                                </div>
                            )}
                            {flashcard && (
                                <div className="p-3 mt-4 bg-lime-50 dark:bg-lime-900/30 text-lime-800 dark:text-lime-200 rounded-lg text-sm shadow"><h4 className="font-semibold mb-2 text-base">{t('flashcardTitle')}</h4><pre className="whitespace-pre-wrap text-sm">{flashcard}</pre></div>
                            )}
                            {explanation && (
                                <div className="p-3 mt-4 bg-blue-50 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-lg text-sm shadow">
                                    <h4 className="font-semibold mb-2 text-base">{t('explanationTitle')}</h4>
                                    <p className="whitespace-pre-wrap">{explanation}</p>
                                    <div className="mt-3 flex flex-col sm:flex-row justify-start items-center gap-2 flex-wrap">
                                        <button onClick={getEli5ExplanationFromLLM} disabled={isGeneratingEli5 || anyLLMLoading} className={`px-4 py-2 rounded-full text-xs font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${isGeneratingEli5 || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-teal-500 hover:bg-teal-600 text-white shadow hover:shadow-md'}`}>
                                            {isGeneratingEli5 ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('simplifyingButton')}</span></> : t('explainSimplyButton')}
                                        </button>
                                        <button onClick={getRealWorldApplicationsFromLLM} disabled={isGeneratingApplications || anyLLMLoading} className={`px-4 py-2 rounded-full text-xs font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${isGeneratingApplications || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-cyan-500 hover:bg-cyan-600 text-white shadow hover:shadow-md'}`}>
                                            {isGeneratingApplications ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingExamplesButton')}</span></> : t('realWorldExamplesButton')}
                                        </button>
                                        <button onClick={generateFollowUpQuestionFromLLM} disabled={isGeneratingFollowUpQuestion || anyLLMLoading} className={`px-4 py-2 rounded-full text-xs font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${isGeneratingFollowUpQuestion || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-gray-700 hover:bg-gray-800 text-white shadow hover:shadow-md'}`}>
                                            {isGeneratingFollowUpQuestion ? <><span className="loading-spinner mr-1 text-xs"></span><span>{t('generatingFollowUpButton')}</span></> : t('followUpQuestionButton')}
                                        </button>
                                        <button onClick={getAnalogyFromLLM} disabled={isGeneratingAnalogy || anyLLMLoading} className={`px-4 py-2 rounded-full text-xs font-medium transition-all duration-200 ease-in-out flex items-center justify-center gap-1 ${isGeneratingAnalogy || anyLLMLoading ? 'bg-gray-300 dark:bg-gray-600 cursor-not-allowed' : 'bg-purple-400 hover:bg-purple-500 text-white shadow hover:shadow-md'}`}>
                                            {isGeneratingAnalogy ? <><span className="loading-spinner-dark mr-1 text-xs"></span><span>{t('generatingAnalogyButton')}</span></> : t('giveAnalogyButton')}
                                        </button>
                                    </div>
                                </div>
                            )}
                            {analogy && (<div className="p-3 mt-4 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-200 rounded-lg text-sm shadow-inner"><h4 className="font-semibold mb-1">{t('analogyTitle')}</h4><p className="whitespace-pre-wrap">{analogy}</p></div>)}
                            {eli5Explanation && (<div className="p-3 mt-4 bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-200 rounded-lg text-sm shadow-inner"><h4 className="font-semibold mb-1">{t('simplifiedExplanationTitle')}</h4><p className="whitespace-pre-wrap">{eli5Explanation}</p></div>)}
                            {realWorldApplications && (<div className="p-3 mt-4 bg-cyan-50 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-200 rounded-lg text-sm shadow-inner"><h4 className="font-semibold mb-1">{t('realWorldExamplesTitle')}</h4><p className="whitespace-pre-wrap">{realWorldApplications}</p></div>)}
                            {followUpQuestion && (<div className="p-3 mt-4 bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded-lg text-sm shadow-inner"><h4 className="font-semibold mb-1">{t('followUpQuestionTitle')}</h4><p className="whitespace-pre-wrap">{followUpQuestion}</p></div>)}
                            
                            <div className="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
                                {!showCancelConfirm ? ( <button className="text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 text-sm underline disabled:text-gray-300 dark:disabled:text-gray-600 disabled:no-underline disabled:cursor-not-allowed transition-colors" onClick={handleCancelRequest} disabled={showResult || !!feedback || anyLLMLoading}> {t('cancelQuizButton')} </button> ) : ( <div className="flex gap-2 items-center"><p className="text-sm text-red-600 dark:text-red-400 font-medium">{t('areYouSure')}</p><button onClick={confirmCancel} className="text-xs bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors shadow">{t('yes')}</button><button onClick={abortCancel} className="text-xs bg-gray-300 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors shadow">{t('no')}</button></div> )}
                                {isNextVisible ? ( <button className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-105 hover:shadow-xl w-full sm:w-auto" onClick={goToNextQuestion} disabled={anyLLMLoading}> {currentIndex === selectedQuestions.length - 1 ? t('showResultButton') : t('nextQuestionButton')} </button> ) : ( <div className="h-12 w-full sm:w-auto"></div> )}
                            </div>
                        </div>
                    </div>
                );
              }
              return <div className="flex items-center justify-center min-h-screen"><ImportQuestionsForm /></div>;
          };

          // Challenge Question Modal
            const ChallengeQuestionModal = React.memo(({
                showModal, onClose, challengeQuestionData, onAnswer, 
                feedbackData, currentAnswer, setAnswer, anyLLMLoading, t
            }) => {
                if (!showModal || !challengeQuestionData) return null;
                const cqOptions = useMemo(() => shuffleArray(challengeQuestionData.options || []), [challengeQuestionData.options]);

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-70 dark:bg-opacity-80 flex items-center justify-center p-4 z-50" onClick={onClose}>
                        <div className="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 ease-in-out scale-95 opacity-0 animate-fadeInUp" 
                             onClick={(e) => e.stopPropagation()} 
                             style={{animationName: 'fadeInUpSlight', animationDuration: '0.3s', animationFillMode: 'forwards'}}
                             dir={appLanguage === 'ar' ? 'rtl' : 'ltr'} >
                            <h2 className="text-2xl font-bold text-yellow-500 dark:text-yellow-400 mb-6 text-center">{t('challengeQuestionTitle')}</h2>
                            <p className="text-lg text-gray-700 dark:text-gray-200 mb-6 text-center">{challengeQuestionData.question}</p>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                                {cqOptions.map((option, idx) => (
                                    <button 
                                        key={idx}
                                        onClick={() => setAnswer(option)}
                                        disabled={!!feedbackData || anyLLMLoading}
                                        className={`py-3 px-4 rounded-lg font-medium shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 disabled:opacity-70 disabled:cursor-not-allowed
                                            ${currentAnswer === option ? 'ring-2 ring-yellow-500 dark:ring-yellow-400' : ''}
                                            ${feedbackData && option === challengeQuestionData.correctAnswer ? 'bg-green-500 text-white' : 
                                              feedbackData && option === currentAnswer && !feedbackData.correct ? 'bg-red-500 text-white' :
                                              'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100'
                                            }`}
                                    >
                                        {option}
                                    </button>
                                ))}
                            </div>
                            {feedbackData && (
                                <div className={`mt-4 p-3 rounded-lg text-center font-semibold text-lg ${feedbackData.correct ? 'bg-green-100 dark:bg-green-800/30 text-green-700 dark:text-green-200' : 'bg-red-100 dark:bg-red-800/30 text-red-700 dark:text-red-200'}`}>
                                    {feedbackData.correct ? t('challengeCorrect') : `${t('challengeIncorrect')} ${feedbackData.correctAnswer}`}
                                </div>
                            )}
                            <div className="mt-6 flex flex-col sm:flex-row justify-center gap-3">
                                {!feedbackData && (
                                    <button 
                                        onClick={() => onAnswer(currentAnswer)} 
                                        disabled={!currentAnswer || anyLLMLoading}
                                        className={`w-full sm:w-auto py-2 px-6 rounded-lg font-semibold transition-colors ${!currentAnswer || anyLLMLoading ? 'bg-gray-400 dark:bg-gray-600 cursor-not-allowed' : 'bg-yellow-500 hover:bg-yellow-600 text-white'}`}
                                    >
                                        {t('submitChallengeAnswer')}
                                    </button>
                                )}
                                <button onClick={onClose} className="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded-lg transition-colors">
                                    {t('closeChallenge')}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            });


          return (
            <>
                <div className={`fixed top-4 ${appLanguage === 'ar' ? 'left-4' : 'right-4'} z-40 flex items-center space-x-2 rtl:space-x-reverse`}>
                    <button 
                        onClick={() => setShowUserProfilePanel(true)} 
                        disabled={anyLLMLoading}
                        className={`p-3 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-110 ${anyLLMLoading ? 'bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white dark:bg-blue-600 dark:hover:bg-blue-700'}`}
                        aria-label={t('profile')}
                    >
                        {userProfile.photoURL ? 
                            <img src={userProfile.photoURL} alt={t('profile')} className="h-6 w-6 rounded-full object-cover"/> :
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        }
                    </button>
                     {userProfile.displayName && (
                        <span className="text-sm font-medium text-gray-700 dark:text-gray-200 hidden sm:inline">{userProfile.displayName}</span>
                    )}
                    <button 
                        onClick={() => setShowSettings(true)} 
                        disabled={anyLLMLoading}
                        className={`p-3 rounded-full shadow-lg transition-all duration-200 ease-in-out transform hover:scale-110 ${anyLLMLoading ? 'bg-gray-300 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white dark:bg-indigo-500 dark:hover:bg-indigo-600 dark:text-gray-100'}`}
                        aria-label={t('settings')}
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
                {showSettings && 
                    <SettingsPanel 
                        currentTheme={theme} 
                        onToggleTheme={toggleTheme} 
                        onClose={() => setShowSettings(false)}
                        currentDefaultAiQuestions={defaultAiQuestions}
                        onSetDefaultAiQuestions={handleDefaultAiQuestionsChange}
                        currentDefaultQuizLength={defaultQuizLength}
                        onSetDefaultQuizLength={handleDefaultQuizLengthChange}
                        currentSoundEffects={soundEffects}
                        onToggleSoundEffects={handleToggleSoundEffects}
                        currentAppLanguage={appLanguage}
                        onSetAppLanguage={handleAppLanguageChange}
                        onResetAllSettings={handleResetSettings}
                        t={t} 
                    />
                }
                {showUserProfilePanel &&
                    <UserProfilePanel
                        currentUserProfile={userProfile}
                        onSaveProfile={saveUserProfileToFirestore}
                        onClose={() => setShowUserProfilePanel(false)}
                        anyLLMLoading={anyLLMLoading}
                        isSaving={isSavingProfile}
                        t={t}
                    />
                }
                <MainContent />
                <ChallengeQuestionModal 
                    showModal={showChallengeQuestionModal}
                    onClose={() => { setShowChallengeQuestionModal(false); setChallengeQuestionFeedback(null); setChallengeQuestionAnswer(''); }}
                    challengeQuestionData={challengeQuestion}
                    onAnswer={handleChallengeAnswer}
                    feedbackData={challengeQuestionFeedback}
                    currentAnswer={challengeQuestionAnswer}
                    setAnswer={setChallengeQuestionAnswer}
                    anyLLMLoading={anyLLMLoading}
                    t={t}
                />
            </>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<QuizApp />);

    </script>
    
    </body>
</html>
