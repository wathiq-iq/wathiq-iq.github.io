<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø£Ø³Ø¦Ù„Ø© ÙˆØªØ­Ø¯ÙŠ ØµÙˆØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§ </text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0369a1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f4f8;
        }
        .option-button, .mode-button {
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .option-button:hover:not(:disabled), .mode-button:hover:not(.bg-sky-700) {
            transform: translateY(-2px);
        }
        .correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a !important;
        }
        .incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626 !important;
        }
        .disabled-button, .mode-button.bg-sky-700 {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .explanation-box {
            background-color: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: #075985;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
        #generated-image-display {
            width: 100%;
            height: 250px; /* Adjust as needed */
            object-fit: contain; /* Or 'cover' depending on desired effect */
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-2 sm:p-4">
    <div class="bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <header class="mb-4 sm:mb-6 text-center">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-sky-700">Ù„Ø¹Ø¨Ø© Ø£Ø³Ø¦Ù„Ø© ÙˆØªØ­Ø¯ÙŠ ØµÙˆØ±</h1>
        </header>

        <div class="flex justify-center gap-2 sm:gap-4 mb-4 sm:mb-6">
            <button id="text-quiz-mode-button" class="mode-button flex-1 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg shadow-md">
                ğŸ“ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù†ØµÙŠØ©
            </button>
            <button id="image-quiz-mode-button" class="mode-button flex-1 bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg shadow-md">
                ğŸ–¼ï¸ ØªØ­Ø¯ÙŠ Ø§Ù„ØµÙˆØ±
            </button>
        </div>

        <div id="score-container" class="mb-2 text-base sm:text-lg font-semibold text-slate-700 text-center">
            Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score" class="text-sky-600">0</span>
        </div>

        <div id="round-progress-container" class="mb-3 sm:mb-4 text-sm sm:text-md text-slate-600 text-center hidden">
        </div>

        <div id="text-quiz-section">
            <div id="question-container" class="mb-4 sm:mb-6 p-3 sm:p-5 bg-sky-50 rounded-lg shadow min-h-[80px] sm:min-h-[100px] flex items-center justify-center">
                <p id="question-text" class="text-lg sm:text-xl text-slate-800 text-center">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ØŒ Ø«Ù… Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©"!</p>
            </div>
        </div>

        <div id="image-challenge-section" class="hidden">
            <div id="image-generation-loader-container" class="text-center mb-3 hidden">
                <div class="loader"></div>
                <p class="text-slate-600 text-sm">Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©...</p>
            </div>
            <div id="image-display-area" class="mb-4 h-56 sm:h-64 bg-slate-200 rounded-lg flex items-center justify-center overflow-hidden">
                <img id="generated-image-display" src="https://placehold.co/400x250/e2e8f0/94a3b8?text=Ø³ÙŠØªÙ…+Ø¹Ø±Ø¶+Ø§Ù„ØµÙˆØ±Ø©+Ù‡Ù†Ø§" alt="ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ø¯ÙŠ" class="hidden"/>
                <p id="image-placeholder-text" class="text-slate-500 text-center p-4">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯Ù‡Ø§...</p>
            </div>
            <div id="image-question-loader-container" class="text-center mb-3 hidden">
                <div class="loader"></div>
                <p class="text-slate-600 text-sm">Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ØµÙˆØ±Ø©...</p>
            </div>
            <div id="image-question-container" class="mb-4 sm:mb-6 p-3 sm:p-5 bg-sky-50 rounded-lg shadow min-h-[60px] sm:min-h-[80px] flex items-center justify-center">
                <p id="image-question-text" class="text-lg sm:text-xl text-slate-800 text-center"></p>
            </div>
        </div>
        
        <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4 mb-4 sm:mb-6">
        </div>

        <div id="feedback-container" class="mb-2 text-center min-h-[20px] sm:min-h-[24px]">
            <p id="feedback-text" class="text-md sm:text-lg font-medium"></p>
        </div>

        <div id="explanation-loader-container" class="text-center mb-2 hidden">
            <div class="loader"></div>
            <p class="text-slate-600 text-xs sm:text-sm">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±Ø­...</p>
        </div>
        <div id="explanation-container" class="mb-3 sm:mb-4 min-h-[18px] sm:min-h-[20px]">
        </div>

        <button id="explain-answer-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 sm:py-2.5 px-3 sm:px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-opacity-50 transition duration-150 ease-in-out mb-2 sm:mb-3 hidden">
            âœ¨ Ø§Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        </button>

        <div id="round-setup-container" class="mb-3 sm:mb-4 p-3 sm:p-4 border border-slate-200 rounded-lg bg-slate-50">
            <div class="mb-2 sm:mb-3">
                <label for="num-questions-input" class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">ğŸ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©/Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø©:</label>
                <input type="number" id="num-questions-input" name="num-questions-input" min="1" max="20" value="3" class="w-20 sm:w-24 p-1.5 sm:p-2 border border-slate-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 text-center">
            </div>
            <div>
                <label for="topic-input" class="block text-xs sm:text-sm font-medium text-slate-700 mb-1">âœ¨ Ø§Ù‚ØªØ±Ø­ Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ù„Ù„Ø¬ÙˆÙ„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                <input type="text" id="topic-input" name="topic-input" class="w-full p-1.5 sm:p-2 border border-slate-300 rounded-lg focus:ring-sky-500 focus:border-sky-500" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙŠÙˆØ§Ù†Ø§ØªØŒ Ù…Ø¯Ù† Ù…Ø´Ù‡ÙˆØ±Ø©ØŒ ÙØ¶Ø§Ø¡">
            </div>
        </div>
        
        <div id="action-buttons-container" class="mt-4">
            <button id="new-question-button" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2.5 sm:py-3 px-3 sm:px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition duration-150 ease-in-out mb-2 sm:mb-3">
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©
            </button>
            <button id="reset-game-button" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2.5 sm:py-3 px-3 sm:px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const textQuizModeButton = document.getElementById('text-quiz-mode-button');
        const imageQuizModeButton = document.getElementById('image-quiz-mode-button');
        const textQuizSection = document.getElementById('text-quiz-section');
        const imageChallengeSection = document.getElementById('image-challenge-section');
        
        const questionTextElement = document.getElementById('question-text'); // For text quiz
        const imageGenerationLoader = document.getElementById('image-generation-loader-container');
        const generatedImageDisplay = document.getElementById('generated-image-display');
        const imagePlaceholderText = document.getElementById('image-placeholder-text');
        const imageQuestionLoader = document.getElementById('image-question-loader-container');
        const imageQuestionTextElement = document.getElementById('image-question-text'); // For image quiz

        const optionsContainerElement = document.getElementById('options-container');
        const feedbackTextElement = document.getElementById('feedback-text');
        const newQuestionButton = document.getElementById('new-question-button');
        const scoreElement = document.getElementById('score');
        const explainAnswerButton = document.getElementById('explain-answer-button');
        const explanationContainer = document.getElementById('explanation-container');
        const explanationLoaderContainer = document.getElementById('explanation-loader-container');
        const topicInput = document.getElementById('topic-input');
        const numQuestionsInput = document.getElementById('num-questions-input');
        const roundProgressContainer = document.getElementById('round-progress-container');
        const resetGameButton = document.getElementById('reset-game-button');

        let currentQuizMode = 'text'; // 'text' or 'image'
        let currentCorrectAnswerIndex = null;
        let currentQuestionFullText = ""; // For text or image question
        let currentCorrectOptionText = "";
        let currentImageBase64 = null; // For image quiz explanations

        let score = 0;
        
        let totalQuestionsInRound = 0;
        let currentQuestionNumberInRound = 0;
        let isRoundActive = false;
        let currentRoundTopic = ""; 
        let askedQuestionsThisRound = []; // Store questions asked in the current round

        let toneJsStarted = false; // Flag to check if Tone.js has been started by user interaction

        // --- API Configuration ---
        const apiKey = "AIzaSyCyBnGDJOMN0ZhXDXthjVZXleT2_XkgVY8"; // IMPORTANT: This should be empty for Canvas environment to inject the key.
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        // imagenApiUrl will be constructed locally in fetchNewImageChallenge


        const questionGenerationSchema = {
            responseMimeType: "application/json",
            responseSchema: {
                type: "OBJECT",
                properties: {
                    question: { type: "STRING", description: "The question in Arabic" },
                    options: {
                        type: "ARRAY",
                        description: "Four answer options in Arabic",
                        items: { type: "STRING" },
                        minItems: 4,
                        maxItems: 4
                    },
                    correctAnswerIndex: { type: "INTEGER", description: "The index of the correct answer (0-3)" , minimum: 0, maximum: 3 }
                },
                required: ["question", "options", "correctAnswerIndex"]
            }
        };

        // --- Sound Effects ---
        let synth; // Declare synth globally to be initialized after user interaction

        function initializeTone() {
            if (!toneJsStarted && typeof Tone !== 'undefined') {
                synth = new Tone.Synth().toDestination();
                Tone.start(); // Request to start audio context
                toneJsStarted = true;
                console.log("Tone.js started and synth initialized.");
            }
        }
        
        function playCorrectAnswerSound() {
            if (toneJsStarted && synth) {
                try {
                    synth.triggerAttackRelease("C5", "2n", Tone.now());
                    synth.triggerAttackRelease("G5", "4n", Tone.now() + 0.08);
                } catch (e) { console.error("Error playing correct sound:", e); }
            }
        }

        function playIncorrectAnswerSound() {
            if (toneJsStarted && synth) {
                try {
                    synth.triggerAttackRelease("C3", "8n", Tone.now());
                    synth.triggerAttackRelease("G2", "8n", Tone.now() + 0.2);
                } catch (e) { console.error("Error playing incorrect sound:", e); }
            }
        }

        function playWinSound() {
            if (toneJsStarted && synth) {
                try {
                    const now = Tone.now();
                    synth.triggerAttackRelease("C4", "8n", now);
                    synth.triggerAttackRelease("E4", "8n", now + 0.2);
                    synth.triggerAttackRelease("G4", "8n", now + 0.4);
                    synth.triggerAttackRelease("C5", "4n", now + 0.6);
                } catch (e) { console.error("Error playing win sound:", e); }
            }
        }


        function setQuizMode(mode) {
            initializeTone(); // Attempt to initialize Tone.js on mode change (user interaction)
            currentQuizMode = mode;
            if (mode === 'text') {
                textQuizSection.classList.remove('hidden');
                imageChallengeSection.classList.add('hidden');
                textQuizModeButton.classList.add('bg-sky-700', 'disabled-button');
                textQuizModeButton.classList.remove('bg-sky-500', 'hover:bg-sky-600');
                imageQuizModeButton.classList.remove('bg-sky-700', 'disabled-button');
                imageQuizModeButton.classList.add('bg-sky-500', 'hover:bg-sky-600');
                questionTextElement.textContent = "Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ØŒ Ø«Ù… Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶ØºØ· \"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©\"!";
            } else if (mode === 'image') {
                textQuizSection.classList.add('hidden');
                imageChallengeSection.classList.remove('hidden');
                imageQuizModeButton.classList.add('bg-sky-700', 'disabled-button');
                imageQuizModeButton.classList.remove('bg-sky-500', 'hover:bg-sky-600');
                textQuizModeButton.classList.remove('bg-sky-700', 'disabled-button');
                textQuizModeButton.classList.add('bg-sky-500', 'hover:bg-sky-600');
                imageQuestionTextElement.textContent = "Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ØŒ Ø«Ù… Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶ØºØ· \"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©\"!";
            }
             if(isRoundActive) endRound(); 
        }
        
        function startNewRound() {
            initializeTone(); // Attempt to initialize Tone.js on starting a new round
            const numQuestions = parseInt(numQuestionsInput.value);
            if (isNaN(numQuestions) || numQuestions < 1 || numQuestions > 50) { 
                feedbackTextElement.textContent = `Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ${currentQuizMode === 'text' ? 'Ø£Ø³Ø¦Ù„Ø©' : 'ØµÙˆØ±'} ØµØ§Ù„Ø­ Ø¨ÙŠÙ† 1 Ùˆ 50.`;
                feedbackTextElement.classList.add('text-red-500');
                return;
            }
            feedbackTextElement.textContent = ""; 
            feedbackTextElement.classList.remove('text-red-500');

            totalQuestionsInRound = numQuestions;
            currentQuestionNumberInRound = 0;
            score = 0; 
            scoreElement.textContent = score;
            isRoundActive = true;
            currentRoundTopic = topicInput.value.trim(); 
            askedQuestionsThisRound = []; // Reset for the new round

            numQuestionsInput.disabled = true;
            topicInput.disabled = true; 
            textQuizModeButton.disabled = true; textQuizModeButton.classList.add('disabled-button');
            imageQuizModeButton.disabled = true; imageQuizModeButton.classList.add('disabled-button');

            newQuestionButton.textContent = currentQuizMode === 'text' ? "Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ" : "Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ØªØ§Ù„ÙŠ";
            roundProgressContainer.classList.remove('hidden');
            
            optionsContainerElement.innerHTML = ''; 
            explainAnswerButton.classList.add('hidden');
            explanationContainer.innerHTML = '';

            if (currentQuizMode === 'text') {
                questionTextElement.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„...";
                fetchNewTextQuestion();
            } else if (currentQuizMode === 'image') {
                imageQuestionTextElement.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£ÙˆÙ„...";
                generatedImageDisplay.classList.add('hidden');
                imagePlaceholderText.classList.remove('hidden');
                imagePlaceholderText.textContent = "Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©...";
                fetchNewImageChallenge();
            }
        }

        function endRound() {
            isRoundActive = false;
            const mainQuestionDisplay = currentQuizMode === 'text' ? questionTextElement : imageQuestionTextElement;
            mainQuestionDisplay.textContent = `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©! Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score} Ù…Ù† ${totalQuestionsInRound}`;
            
            if(currentQuizMode === 'image') {
                generatedImageDisplay.classList.add('hidden');
                imagePlaceholderText.classList.remove('hidden');
                imagePlaceholderText.textContent = `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©! Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score} Ù…Ù† ${totalQuestionsInRound}`;
            }

            optionsContainerElement.innerHTML = '';
            feedbackTextElement.textContent = 'Ø£Ø­Ø³Ù†Øª!';
            feedbackTextElement.classList.remove('text-red-500', 'text-green-500');
            feedbackTextElement.classList.add('text-sky-600');
            playWinSound(); // Play win sound

            explainAnswerButton.classList.add('hidden');
            explanationContainer.innerHTML = '';
            newQuestionButton.textContent = "Ø§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©";
            numQuestionsInput.disabled = false;
            topicInput.disabled = false; 
            textQuizModeButton.disabled = false; textQuizModeButton.classList.remove('disabled-button');
            imageQuizModeButton.disabled = false; imageQuizModeButton.classList.remove('disabled-button');
            roundProgressContainer.classList.add('hidden');
            currentQuestionNumberInRound = 0; 
        }

        async function fetchNewTextQuestion() {
            if (!isRoundActive || currentQuestionNumberInRound >= totalQuestionsInRound) {
                if(isRoundActive) endRound();
                return;
            }
            currentQuestionNumberInRound++;
            roundProgressContainer.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionNumberInRound} Ù…Ù† ${totalQuestionsInRound}`;
            
            newQuestionButton.disabled = true; newQuestionButton.classList.add('disabled-button');
            textQuizSection.querySelector('#question-container').classList.remove('hidden'); 
            const textQuestionLoader = document.createElement('div'); 
            textQuestionLoader.className = 'loader';
            questionTextElement.innerHTML = ''; 
            questionTextElement.appendChild(textQuestionLoader);

            optionsContainerElement.innerHTML = '';
            feedbackTextElement.textContent = '';
            explainAnswerButton.classList.add('hidden');
            explanationContainer.innerHTML = '';

            try {
                let basePrompt;
                if (currentRoundTopic) { 
                    basePrompt = `Generate a single quiz question about the topic: "${currentRoundTopic}". The question and its four answer options must be in Classical Arabic (Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰). Only one option should be correct. Provide diverse and clear options. Specify the index of the correct answer (0-3). Ensure the question is relevant to the given topic.`;
                } else { 
                    basePrompt = `Generate a single quiz question in the field of "${currentRoundTopic}". The question and its four answer options must be in Classical Arabic (Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰). Only one option should be correct. Provide diverse and clear options. Specify the index of the correct answer (0-3).`;
                }

                let prompt = basePrompt;
                if (askedQuestionsThisRound.length > 0) {
                    const exclusions = askedQuestionsThisRound.map(q => `"${q}"`).join(', ');
                    prompt += ` IMPORTANT: This question must be different from any of the following questions that have already been asked in this round: [${exclusions}].`;
                }

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: questionGenerationSchema
                };
                const response = await fetch(geminiApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error (Text Question): ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const quizData = JSON.parse(result.candidates[0].content.parts[0].text);
                    if (quizData.question && quizData.options && quizData.options.length === 4 && quizData.correctAnswerIndex !== undefined) {
                        if (askedQuestionsThisRound.includes(quizData.question) && askedQuestionsThisRound.length < 5) { // Retry if duplicate and not too many retries
                            console.warn("Duplicate text question received, retrying...");
                            currentQuestionNumberInRound--; // Decrement to re-fetch for the same number
                            fetchNewTextQuestion();
                            return;
                        }
                        askedQuestionsThisRound.push(quizData.question); 
                        displayQuestion(quizData.question, quizData.options, quizData.correctAnswerIndex, questionTextElement);
                    } else throw new Error("Invalid data structure from API (Text Question).");
                } else throw new Error("No valid content in API response (Text Question).");
            } catch (error) {
                console.error('Error fetching text question:', error);
                questionTextElement.textContent = 'Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù†ØµÙŠ.';
                feedbackTextElement.textContent = `Ø®Ø·Ø£: ${error.message}`;
                newQuestionButton.disabled = false; newQuestionButton.classList.remove('disabled-button');
            }
        }

        async function fetchNewImageChallenge() {
            if (!isRoundActive || currentQuestionNumberInRound >= totalQuestionsInRound) {
                 if(isRoundActive) endRound();
                return;
            }
            currentQuestionNumberInRound++;
            roundProgressContainer.textContent = `Ø§Ù„ØªØ­Ø¯ÙŠ ${currentQuestionNumberInRound} Ù…Ù† ${totalQuestionsInRound}`;

            newQuestionButton.disabled = true; newQuestionButton.classList.add('disabled-button');
            imageGenerationLoader.classList.remove('hidden');
            imageQuestionLoader.classList.add('hidden');
            generatedImageDisplay.classList.add('hidden');
            imagePlaceholderText.classList.remove('hidden');
            imagePlaceholderText.textContent = "Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø©...";
            imageQuestionTextElement.textContent = '';
            optionsContainerElement.innerHTML = '';
            feedbackTextElement.textContent = '';
            explainAnswerButton.classList.add('hidden');
            explanationContainer.innerHTML = '';
            currentImageBase64 = null;

            try {
                // 1. Generate Image with Imagen
                let imagePrompt = currentRoundTopic ? `A clear, interesting, and quiz-worthy image related to: "${currentRoundTopic}". Focus on a single subject or a clear scene.` : "A random interesting and clear image suitable for a visual quiz, like a famous landmark, an animal, an object, or a simple scene.";
                
                const correctedImagenPayload = {
                    instances: { prompt: imagePrompt },
                    parameters: { "sampleCount": 1 }
                };

                const localImagenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                console.log("Attempting Imagen API call to:", localImagenApiUrl); 
                console.log("With Imagen payload:", JSON.stringify(correctedImagenPayload)); 
                
                const imagenResponse = await fetch(localImagenApiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(correctedImagenPayload) 
                });

                if (!imagenResponse.ok) {
                    const errorText = await imagenResponse.text();
                    console.error("Imagen API Response Error Text:", errorText);
                    throw new Error(`Imagen API error: ${imagenResponse.status}`); 
                }
                const imagenResult = await imagenResponse.json();

                if (!imagenResult.predictions || imagenResult.predictions.length === 0 || !imagenResult.predictions[0].bytesBase64Encoded) {
                    console.error("Imagen API - Invalid predictions structure:", imagenResult);
                    throw new Error("Failed to generate image or received invalid image data.");
                }
                currentImageBase64 = imagenResult.predictions[0].bytesBase64Encoded;
                generatedImageDisplay.src = `data:image/png;base64,${currentImageBase64}`;
                generatedImageDisplay.classList.remove('hidden');
                imagePlaceholderText.classList.add('hidden');
                imageGenerationLoader.classList.add('hidden');
                imageQuestionLoader.classList.remove('hidden'); 

                // 2. Generate Question about the Image with Gemini
                let baseGeminiImagePrompt = `Analyze this image. Generate a single, clear quiz question in Classical Arabic (Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰) specifically about the content or subject of this image. Provide four multiple-choice options also in Classical Arabic, with only one correct answer. Specify the index of the correct answer (0-3). The question should be engaging and directly related to what is visible in the image.`;
                let geminiImagePrompt = baseGeminiImagePrompt;
                if (askedQuestionsThisRound.length > 0) {
                    const exclusions = askedQuestionsThisRound.map(q => `"${q}"`).join(', ');
                    geminiImagePrompt += ` IMPORTANT: The textual part of this question must be different from any of the following textual questions that have already been asked in this round: [${exclusions}].`;
                }

                const geminiPayload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: geminiImagePrompt },
                            { inlineData: { mimeType: "image/png", data: currentImageBase64 } }
                        ]
                    }],
                    generationConfig: questionGenerationSchema
                };
                const geminiResponse = await fetch(geminiApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(geminiPayload) });
                if (!geminiResponse.ok) throw new Error(`Gemini API error (Image Question): ${geminiResponse.status}`);
                const geminiResult = await geminiResponse.json();
                
                imageQuestionLoader.classList.add('hidden');
                if (geminiResult.candidates && geminiResult.candidates[0].content && geminiResult.candidates[0].content.parts[0].text) {
                    const quizData = JSON.parse(geminiResult.candidates[0].content.parts[0].text);
                     if (quizData.question && quizData.options && quizData.options.length === 4 && quizData.correctAnswerIndex !== undefined) {
                        if (askedQuestionsThisRound.includes(quizData.question) && askedQuestionsThisRound.length < 5) { // Retry for image questions too
                            console.warn("Duplicate image question received, retrying...");
                            currentQuestionNumberInRound--; 
                            fetchNewImageChallenge();
                            return;
                        }
                        askedQuestionsThisRound.push(quizData.question); 
                        displayQuestion(quizData.question, quizData.options, quizData.correctAnswerIndex, imageQuestionTextElement);
                    } else throw new Error("Invalid data structure from Gemini API (Image Question).");
                } else throw new Error("No valid content in Gemini API response (Image Question).");

            } catch (error) {
                console.error('Error fetching image challenge:', error);
                imageGenerationLoader.classList.add('hidden');
                imageQuestionLoader.classList.add('hidden');
                imagePlaceholderText.classList.remove('hidden');
                imagePlaceholderText.textContent = 'Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¶ÙŠØ± ØªØ­Ø¯ÙŠ Ø§Ù„ØµÙˆØ±Ø©.';
                imageQuestionTextElement.textContent = 'Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¶ÙŠØ± ØªØ­Ø¯ÙŠ Ø§Ù„ØµÙˆØ±Ø©.';
                feedbackTextElement.textContent = `Ø®Ø·Ø£: ${error.message}`;
                newQuestionButton.disabled = false; newQuestionButton.classList.remove('disabled-button');
            }
        }


        function displayQuestion(question, options, correctAnswerIdx, questionElement) {
            currentQuestionFullText = question;
            questionElement.textContent = currentQuestionFullText;
            currentCorrectAnswerIndex = correctAnswerIdx;
            currentCorrectOptionText = options[correctAnswerIdx];
            optionsContainerElement.innerHTML = ''; 

            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button', 'w-full', 'p-2', 'sm:p-3', 'bg-slate-200', 'hover:bg-slate-300', 'text-slate-700', 'font-semibold', 'rounded-lg', 'border-2', 'border-slate-300', 'focus:outline-none', 'focus:ring-2', 'focus:ring-sky-500', 'text-sm', 'sm:text-base');
                button.dataset.index = index;
                button.addEventListener('click', handleOptionClick);
                optionsContainerElement.appendChild(button);
            });
            feedbackTextElement.textContent = '';
            newQuestionButton.disabled = true; 
            newQuestionButton.classList.add('disabled-button'); 
            explainAnswerButton.classList.add('hidden'); 
            explanationContainer.innerHTML = ''; 
        }

        function handleOptionClick(event) {
            initializeTone(); // Ensure Tone.js is started on first option click if not already
            const selectedOptionButton = event.target;
            const selectedAnswerIndex = parseInt(selectedOptionButton.dataset.index);

            const optionButtons = optionsContainerElement.querySelectorAll('.option-button');
            optionButtons.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled-button');
            });

            if (selectedAnswerIndex === currentCorrectAnswerIndex) {
                selectedOptionButton.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'border-slate-300');
                selectedOptionButton.classList.add('correct');
                feedbackTextElement.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!';
                feedbackTextElement.classList.remove('text-red-500');
                feedbackTextElement.classList.add('text-green-500');
                score++;
                scoreElement.textContent = score;
                playCorrectAnswerSound();
            } else {
                selectedOptionButton.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'border-slate-300');
                selectedOptionButton.classList.add('incorrect');
                feedbackTextElement.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©.';
                feedbackTextElement.classList.remove('text-green-500');
                feedbackTextElement.classList.add('text-red-500');
                playIncorrectAnswerSound();

                optionButtons.forEach(btn => {
                    if (parseInt(btn.dataset.index) === currentCorrectAnswerIndex) {
                        btn.classList.remove('bg-slate-200', 'hover:bg-slate-300', 'border-slate-300');
                        btn.classList.add('correct');
                    }
                });
            }
            explainAnswerButton.classList.remove('hidden'); 
            newQuestionButton.disabled = false; 
            newQuestionButton.classList.remove('disabled-button');
            if (currentQuestionNumberInRound >= totalQuestionsInRound) {
                newQuestionButton.textContent = "Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©";
            }
        }

        async function fetchAnswerExplanation() {
            explainAnswerButton.disabled = true;
            explainAnswerButton.classList.add('disabled-button');
            explanationLoaderContainer.classList.remove('hidden');
            explanationContainer.innerHTML = '';

            try {
                let prompt;
                let payloadContent = [];

                if (currentQuizMode === 'image' && currentImageBase64) {
                    prompt = `For the image provided, the question was: "${currentQuestionFullText}". The correct answer was: "${currentCorrectOptionText}". Please provide a brief and clear explanation (2-3 sentences) in Classical Arabic (Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰) why this answer is correct in relation to the image, or offer some interesting additional information about the image's subject. The explanation must be in Arabic.`;
                    payloadContent.push({ text: prompt });
                    payloadContent.push({ inlineData: { mimeType: "image/png", data: currentImageBase64 } });
                } else {
                    prompt = `The question was: "${currentQuestionFullText}". The correct answer was: "${currentCorrectOptionText}". Please provide a brief and clear explanation (2-3 sentences) in Classical Arabic (Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰) why this answer is correct, or offer some interesting additional information about the topic. The explanation must be in Arabic.`;
                    payloadContent.push({ text: prompt });
                }
                
                const payload = {
                    contents: [{ role: "user", parts: payloadContent }]
                };

                const response = await fetch(geminiApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error (Explanation): ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const explanationText = result.candidates[0].content.parts[0].text;
                    explanationContainer.innerHTML = `<div class="explanation-box">${explanationText}</div>`;
                } else throw new Error("No valid explanation content in API response.");
            } catch (error) {
                console.error('Error fetching explanation:', error);
                explanationContainer.innerHTML = `<div class="explanation-box text-red-600">Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±Ø­: ${error.message}</div>`;
            } finally {
                explanationLoaderContainer.classList.add('hidden');
                explainAnswerButton.disabled = false;
                explainAnswerButton.classList.remove('disabled-button');
            }
        }
        
        function initializeApp() {
            isRoundActive = false;
            score = 0;
            scoreElement.textContent = score;
            currentQuestionNumberInRound = 0;
            totalQuestionsInRound = 0;
            currentRoundTopic = "";
            currentImageBase64 = null;
            askedQuestionsThisRound = []; 

            setQuizMode('text'); 

            questionTextElement.textContent = "Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ØŒ Ø«Ù… Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ø¶ØºØ· 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©' Ù„Ù„Ø¨Ø¯Ø¡!";
            imageQuestionTextElement.textContent = "";
            generatedImageDisplay.classList.add('hidden');
            generatedImageDisplay.src = "https://placehold.co/400x250/e2e8f0/94a3b8?text=Ø³ÙŠØªÙ…+Ø¹Ø±Ø¶+Ø§Ù„ØµÙˆØ±Ø©+Ù‡Ù†Ø§";
            imagePlaceholderText.classList.remove('hidden');
            imagePlaceholderText.textContent = "Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯Ù‡Ø§...";


            optionsContainerElement.innerHTML = '';
            feedbackTextElement.textContent = '';
            feedbackTextElement.classList.remove('text-red-500', 'text-green-500', 'text-sky-600');
            
            explainAnswerButton.classList.add('hidden');
            explanationContainer.innerHTML = '';
            explanationLoaderContainer.classList.add('hidden');
            imageGenerationLoader.classList.add('hidden');
            imageQuestionLoader.classList.add('hidden');
            
            roundProgressContainer.classList.add('hidden');
            roundProgressContainer.textContent = ''; 

            numQuestionsInput.disabled = false;
            numQuestionsInput.value = currentQuizMode === 'text' ? "5" : "3"; 
            topicInput.disabled = false;
            topicInput.value = '';

            newQuestionButton.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©";
            newQuestionButton.disabled = false;
            newQuestionButton.classList.remove('disabled-button');

            textQuizModeButton.disabled = false; textQuizModeButton.classList.remove('disabled-button');
            imageQuizModeButton.disabled = false; imageQuizModeButton.classList.remove('disabled-button');
            if (currentQuizMode === 'text') {
                textQuizModeButton.classList.add('bg-sky-700', 'disabled-button');
                imageQuizModeButton.classList.remove('bg-sky-700', 'disabled-button');
                 imageQuizModeButton.classList.add('bg-sky-500', 'hover:bg-sky-600');
            } else {
                imageQuizModeButton.classList.add('bg-sky-700', 'disabled-button');
                textQuizModeButton.classList.remove('bg-sky-700', 'disabled-button');
                textQuizModeButton.classList.add('bg-sky-500', 'hover:bg-sky-600');
            }
        }

        // Event Listeners
        textQuizModeButton.addEventListener('click', () => setQuizMode('text'));
        imageQuizModeButton.addEventListener('click', () => setQuizMode('image'));

        newQuestionButton.addEventListener('click', () => {
            initializeTone(); // Ensure Tone.js is started on first "Start Round" click
            if (!isRoundActive) {
                startNewRound();
            } else {
                if (currentQuizMode === 'text') fetchNewTextQuestion();
                else if (currentQuizMode === 'image') fetchNewImageChallenge();
            }
        });
        explainAnswerButton.addEventListener('click', fetchAnswerExplanation);
        resetGameButton.addEventListener('click', initializeApp); 

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        initializeApp(); 
    </script>
</body>
</html>
